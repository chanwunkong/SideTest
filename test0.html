<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Allosaurus Áâ©ÁêÜÈü≥‰ΩçË®∫Êñ∑Âô®</title>
    <script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script>
    <style>
        /* (‰øùÁïô‰πãÂâçÁöÑ CSS Ê®£ÂºèË®≠ÂÆö) */
        :root {
            --bg: #0b1220;
            --card: #111827;
            --text: #e5e7eb;
            --accent: #22d3ee;
            --record: #ef4444;
            --success: #10b981;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .app-card {
            background: var(--card);
            border-radius: 24px;
            padding: 30px;
            border: 1px solid #1f2937;
            text-align: center;
            max-width: 600px;
            width: 100%;
        }

        .record-btn {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: var(--record);
            border: none;
            cursor: pointer;
            margin: 10px 0;
        }

        .record-btn.active {
            animation: pulse 1.5s infinite;
            background: #991b1b;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        #timer {
            font-size: 18px;
            color: #94a3b8;
            margin-bottom: 10px;
        }

        #status {
            margin-top: 15px;
            color: var(--accent);
            font-size: 14px;
        }

        #ipa-full {
            font-size: 32px;
            color: var(--accent);
            margin: 20px 0;
            letter-spacing: 4px;
        }

        .ph-block {
            display: inline-block;
            padding: 12px 20px;
            background: #1f2937;
            border-radius: 12px;
            cursor: pointer;
            margin: 5px;
            border: 1px solid #334155;
        }

        .ph-block.active {
            background: var(--accent);
            color: #000;
        }

        #diag-box {
            display: none;
            margin-top: 25px;
            padding: 20px;
            background: rgba(34, 211, 238, 0.05);
            border-radius: 16px;
            border-left: 5px solid var(--accent);
            text-align: left;
        }
    </style>
</head>

<body>

    <div class="app-card">
        <h1>Allosaurus Èü≥‰ΩçÂ∞éËà™</h1>
        <div id="timer">00:00</div>
        <button class="record-btn" id="recordBtn">üé§</button>
        <div id="status">Ê∫ñÂÇôÂ∞±Á∑í (Â∑≤‰øÆÂæ© WAV Ê†ºÂºè)</div>
        <div id="ipa-full"></div>
        <div id="phoneme-wrap"></div>
        <div id="diag-box">
            <div id="diag-content"></div>
        </div>
    </div>

    <script>
        const ALLOSAURUS_API = "https://allosaurus-api-878665537417.asia-east1.run.app/recognize";
        let audioContext;
        let recorder;
        let gumStream;
        let timerInterval;
        let seconds = 0;

        const recordBtn = document.getElementById('recordBtn');
        const status = document.getElementById('status');
        const timerDisplay = document.getElementById('timer');

        recordBtn.onclick = function () {
            if (recorder && recorder.recording) {
                stopRecording();
                this.classList.remove('active');
            } else {
                startRecording();
                this.classList.add('active');
            }
        };

        async function startRecording() {
            const constraints = { audio: true };
            navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gumStream = stream;
                const input = audioContext.createMediaStreamSource(stream);
                // ÈÄôË£°ÊúÉÂº∑Âà∂Â∞áÈü≥Ë®äËΩâÁÇ∫ÂñÆËÅ≤ÈÅì PCM
                recorder = new Recorder(input, { numChannels: 1 });
                recorder.record();

                status.textContent = "Ê≠£Âú®ÈåÑÈü≥ (Áî¢ÁîüÊ®ôÊ∫ñ RIFF WAV)...";
                startTimer();
            });
        }

        function stopRecording() {
            recorder.stop();
            gumStream.getAudioTracks()[0].stop();
            clearInterval(timerInterval);

            // ÈÄôÊòØÈóúÈçµÔºöÂåØÂá∫ÁúüÊ≠£ÁöÑ WAV Ê™îÊ°à
            recorder.exportWAV(function (blob) {
                processAudio(blob);
            });
        }

        async function processAudio(blob) {
            const key = localStorage.getItem('gptApiKey');
            if (!key) { status.textContent = "ÈåØË™§ÔºöÁº∫Â∞ë API Key"; return; }

            status.textContent = "Ê≠•È©ü 1/2ÔºöÊ≠£Âú®ÂÇ≥ÈÄÅÊ®ôÊ∫ñ WAV Ê™îÊ°à...";
            const formData = new FormData();
            formData.append("file", blob, "recording.wav");

            try {
                const resp = await fetch(ALLOSAURUS_API, { method: "POST", body: formData });
                const data = await resp.json();
                if (data.error) throw new Error(data.error);

                document.getElementById('ipa-full').textContent = `[ ${data.ipa} ]`;
                status.textContent = "Ê≠•È©ü 2/2ÔºöAI Ë®∫Êñ∑‰∏≠...";

                // (GPT Ë®∫Êñ∑ÈÇèËºØËàá‰πãÂâçÁõ∏ÂêåÔºåÁï•)
                getGPTDiagnosis(data.ipa, key);
            } catch (e) {
                status.textContent = "ÈåØË™§Ôºö" + e.message;
            }
        }

        async function getGPTDiagnosis(ipa, key) {
            const prompt = `‰Ω†ÁèæÂú®ÊòØË™ûÈü≥Áâ©ÁêÜÂ≠∏ÂÆ∂„ÄÇAllosaurus Ëæ®Ë≠òÂá∫ÁôºÈü≥ÁÇ∫ "${ipa}"„ÄÇË´ãÁµ¶Âá∫ JSON: {"phonemes": [{"s": "Èü≥Á¥†", "guide": "ËÇåËÇâË™øÊï¥Êåá‰ª§", "pos": "Â∫ßÊ®ô"}]}`;
            const aiResp = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [{ role: "user", content: prompt }],
                    response_format: { type: "json_object" }
                })
            });
            const aiData = await aiResp.json();
            renderUI(JSON.parse(aiData.choices[0].message.content));
            status.textContent = "‚úÖ ÂàÜÊûêÊàêÂäü";
        }

        function renderUI(data) {
            const wrap = document.getElementById('phoneme-wrap');
            wrap.innerHTML = "";
            data.phonemes.forEach(ph => {
                const div = document.createElement('div');
                div.className = "ph-block";
                div.textContent = ph.s;
                div.onclick = () => {
                    document.getElementById('diag-box').style.display = "block";
                    document.getElementById('diag-content').innerHTML = `<b>Â∫ßÊ®ôÔºö</b>${ph.pos}<br><b>Êåá‰ª§Ôºö</b>${ph.guide}`;
                };
                wrap.appendChild(div);
            });
        }

        function startTimer() {
            seconds = 0;
            timerInterval = setInterval(() => {
                seconds++;
                timerDisplay.textContent = new Date(seconds * 1000).toISOString().substr(14, 5);
            }, 1000);
        }
    </script>
</body>

</html>