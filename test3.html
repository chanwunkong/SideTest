<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>語塊流動場 v2.9 - 協議同步版</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <script src="config.js"></script>
    <script src="prompts.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* 佈局專用樣式 */
        #initOverlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>
    <div id="initOverlay">
        <div class="init-card">
            <h2>語塊協議啟動</h2>
            <input type="text" id="sceneInput" placeholder="輸入場景（如：咖啡廳、面試）">
            <button onclick="startProtocol(document.getElementById('sceneInput').value)"
                style="width: 100%;">開始實戰</button>
        </div>
    </div>

    <div class="hud-header">
        <div id="assetRack" class="asset-rack"></div>
    </div>

    <div id="chatBox"></div>

    <div class="dealer-tray">
        <div id="optionsContainer"></div>
    </div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="手動覆寫或輸入...">
        <button id="sendBtn">發送</button>
    </div>

    <script>
        let wordAssets = {};
        let currentScene = "";

        // 徹底清潔 API Key，防止 ISO-8859-1 錯誤
        function getActiveSettings() {
            let rawKey = localStorage.getItem('gptApiKey') || "";
            const cleanKey = rawKey.replace(/[^\x00-\x7F]/g, "").trim();
            return {
                key: cleanKey,
                lang: localStorage.getItem('userLang') || 'en-US',
                course: localStorage.getItem('userCourse') || 'Stage 1'
            };
        }

        async function startProtocol(scene) {
            document.getElementById('initOverlay').style.display = 'none';
            currentScene = scene || "Daily Conversation";
            const settings = getActiveSettings();

            // 透過 prompts.js 獲取指令
            const prompt = `Start roleplay in ${currentScene}. Return AI opening chunks. JSON: {"s": [{"t": "Hello", "p": "other"}]}`;
            const res = await fetchGPT(prompt);
            const data = JSON.parse(res);
            renderTurn(data.s);
        }

        async function renderTurn(aiChunks) {
            appendMsg("AI", aiChunks);
            const settings = getActiveSettings();

            // 調用外部 prompts.js 的發牌指令
            const prompt = CHUNK_PROMPTS.getTest3Prompt(settings.lang, settings.course, currentScene);
            const res = await fetchGPT(prompt);
            const options = JSON.parse(res);

            const container = document.getElementById('optionsContainer');
            container.innerHTML = "";
            ['heavy', 'light', 'distractor'].forEach(type => {
                const btn = document.createElement('button');
                btn.className = 'signal-option';
                options[type].forEach(c => {
                    const span = document.createElement('span');
                    span.className = `chunk ${c.p}`;
                    span.innerText = c.t;
                    btn.appendChild(span);
                });
                btn.onclick = () => handleChoice(options[type]);
                container.appendChild(btn);
            });
        }

        async function handleChoice(chunks) {
            appendMsg("User", chunks);
            const text = chunks.map(c => c.t).join(" ");
            const settings = getActiveSettings();

            const prompt = `Scene: ${currentScene}. User said: "${text}". Reply with chunks. JSON: {"s": [{"t": "...", "p": "pos"}]}`;
            const res = await fetchGPT(prompt);
            renderTurn(JSON.parse(res).s);
        }

        function appendMsg(role, chunks) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `message ${role === 'AI' ? 'ai-msg' : 'user-msg'}`;

            chunks.forEach(c => {
                const span = document.createElement('span');
                span.className = `chunk ${c.p}`;
                span.innerText = c.t + " ";
                div.appendChild(span);
            });

            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            speak(chunks.map(c => c.t).join(" "));
        }

        async function fetchGPT(prompt) {
            const settings = getActiveSettings();
            if (!settings.key) return alert("API Key Missing");

            const res = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${settings.key}`
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [{ role: "user", content: prompt }],
                    response_format: { type: "json_object" }
                })
            });
            const data = await res.json();
            return data.choices[0].message.content;
        }

        function speak(text) {
            speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = getActiveSettings().lang;
            speechSynthesis.speak(u);
        }
    </script>
</body>

</html>