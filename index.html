<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èªè¨€ç·´ç¿’</title>
    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <script src="config.js"></script>
</head>

<body>
    <div class="wrap">
        <div class="header">
            <span id="userEmail">æœªç™»å…¥</span>
        </div>

        <h1>å­¸ç¿’æ§åˆ¶ä¸­å¿ƒ</h1>

        <div class="card">
            <button id="authBtn">ä½¿ç”¨ Google ç™»å…¥</button>

            <label>GPT API KEY</label>
            <input type="password" id="gptApiKey" placeholder="sk-...">

            <label>ç›®æ¨™å­¸ç¿’èªè¨€</label>
            <select id="userLang">
                <option value="en-US">English ğŸ‡ºğŸ‡¸</option>
                <option value="it-IT">Italiano ğŸ‡®ğŸ‡¹</option>
                <option value="zh-TW">ä¸­æ–‡ (ç¹é«”) ğŸ‡¹ğŸ‡¼</option>
                <option value="ja-JP">æ—¥æœ¬èª ğŸ‡¯ğŸ‡µ</option>
                <option value="fr-FR">FranÃ§ais ğŸ‡«ğŸ‡·</option>
                <option value="de-DE">Deutsch ğŸ‡©ğŸ‡ª</option>
                <option value="es-ES">EspaÃ±ol ğŸ‡ªğŸ‡¸</option>
                <option value="pt-PT">PortuguÃªs ğŸ‡µğŸ‡¹</option>
                <option value="ru-RU">Ğ ÑƒÑÑĞºĞ¸Ğ¹ ğŸ‡·ğŸ‡º</option>
                <option value="hi-IN">à¤¹à¤¿à¤¨à¥à¤¦à¥€ / Ø§ÙØ±Ø¯ÙÙˆ ğŸ‡®ğŸ‡³</option>
                <option value="bn-BD">à¦¬à¦¾à¦‚à¦²à¦¾ ğŸ‡§ğŸ‡©</option>
                <option value="fa-IR">ÙØ§Ø±Ø³ÛŒ ğŸ‡®ğŸ‡·</option>
                <option value="ta-IN">à®¤à®®à®¿à®´à¯ ğŸ‡®ğŸ‡³</option>
                <option value="ar-SA">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ğŸ‡¸ğŸ‡¦</option>
                <option value="tr-TR">TÃ¼rkÃ§e ğŸ‡¹ğŸ‡·</option>
                <option value="ko-KR">í•œêµ­ì–´ ğŸ‡°ğŸ‡·</option>
                <option value="vi-VN">Tiáº¿ng Viá»‡t ğŸ‡»ğŸ‡³</option>
                <option value="id-ID">Bahasa Indonesia / Melayu ğŸ‡®ğŸ‡©</option>
                <option value="th-TH">à¹„à¸—à¸¢ ğŸ‡¹ğŸ‡­</option>
                <option value="sw-KE">Kiswahili ğŸ‡°ğŸ‡ª</option>
            </select>
            <label>å­¸ç¿’èª²ç¨‹é€²åº¦</label>
            <select id="userCourse">
                <option value="all">å…¨éƒ¨å–®å­—</option>
                <option value="Stage 1">Stage 1: Core 40 (æ ¸å¿ƒè©)</option>
                <option value="Stage 2">Stage 2: Swadesh (åŸºç¤è©)</option>
                <option value="Stage 3">Stage 3: CEFR (åˆ†ç´šå–®å­—)</option>
            </select>

            <button id="saveKeyBtn" style="background: var(--btn); color: white; margin-top: 15px;">å„²å­˜è¨­å®š</button>
        </div>

        <div class="grid">
            <a href="test0.html" class="nav-box box-0">éŸ³ä½è¨ºæ–·</a>
            <a href="test1.html" class="nav-box box-1">å–®å­—æ‰‹å¯«</a>
            <a href="test2.html" class="nav-box box-2">èªæ³•æ’åº</a>
            <a href="#" class="nav-box box-3">å­¸ç¿’æ•¸æ“š</a>
        </div>
    </div>

    <script>
        // 1. å–å¾—å…ƒä»¶ (åƒ…ä¿ç•™ç›®å‰ HTML å­˜åœ¨çš„ ID)
        const authBtn = document.getElementById('authBtn');
        const saveKeyBtn = document.getElementById('saveKeyBtn');
        const userEmailSpan = document.getElementById('userEmail');
        const keyInput = document.getElementById('gptApiKey');
        const langSelect = document.getElementById('userLang');
        const courseSelect = document.getElementById('userCourse');

        // 2. åˆå§‹åŒ–é é¢ï¼šå¾ config.js è®€å–æœ¬åœ°å¿«å–
        function loadLocalSettings() {
            const settings = getGlobalSettings();
            if (keyInput) keyInput.value = settings.key;
            if (langSelect) langSelect.value = settings.lang;
            if (courseSelect) courseSelect.value = settings.course;
        }
        loadLocalSettings();

        // 3. ç›£è½ç™»å…¥ç‹€æ…‹ä¸¦æ›´æ–°å–®ä¸€æŒ‰éˆ• UI
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // --- å·²ç™»å…¥ç‹€æ…‹ ---
                console.log("ä½¿ç”¨è€…å·²ç™»å…¥:", user.email);
                userEmailSpan.textContent = user.email;

                // æ›´æ–°æŒ‰éˆ•å¤–è§€èˆ‡è¡Œç‚ºç‚ºã€Œç™»å‡ºã€
                authBtn.textContent = "ç™»å‡ºå¸³è™Ÿ";
                authBtn.style.background = "#ff4d4d";
                authBtn.onclick = () => {
                    console.log("è§¸ç™¼ Google å½ˆå‡ºå¼ç™»å…¥...");
                    const provider = new firebase.auth.GoogleAuthProvider();

                    // æ”¹ç”¨ Popupï¼Œé¿å… GitHub Page é‡æ–°æ•´ç†å°è‡´ç‹€æ…‹éºå¤±
                    auth.signInWithPopup(provider)
                        .then((result) => {
                            console.log("ç™»å…¥æˆåŠŸï¼Œä½¿ç”¨è€…ï¼š", result.user.email);
                            // æˆåŠŸå¾Œä¸éœ€è¦æ‰‹å‹• reloadï¼ŒonAuthStateChanged æœƒè‡ªå‹•åµæ¸¬
                        })
                        .catch((error) => {
                            console.error("ç™»å…¥å¤±æ•—è©³æƒ…ï¼š", error.code, error.message);
                            alert("ç™»å…¥å¤±æ•—ï¼š" + error.message);
                        });
                };

                // åŒæ­¥é›²ç«¯è³‡æ–™åˆ°æœ¬åœ°
                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.gptApiKey) {
                            keyInput.value = data.gptApiKey;
                            localStorage.setItem('gptApiKey', data.gptApiKey);
                        }
                        if (data.userLang) {
                            langSelect.value = data.userLang;
                            localStorage.setItem('userLang', data.userLang);
                        }
                        if (data.userCourse) {
                            courseSelect.value = data.userCourse;
                            localStorage.setItem('userCourse', data.userCourse);
                        }
                    }
                } catch (e) {
                    console.error("é›²ç«¯è³‡æ–™è®€å–å¤±æ•—", e);
                }
            } else {
                // --- æœªç™»å…¥ç‹€æ…‹ ---
                console.log("ä½¿ç”¨è€…æœªç™»å…¥");
                userEmailSpan.textContent = "æœªç™»å…¥";

                // æ›´æ–°æŒ‰éˆ•å¤–è§€èˆ‡è¡Œç‚ºç‚ºã€Œç™»å…¥ã€
                authBtn.textContent = "ä½¿ç”¨ Google ç™»å…¥";
                authBtn.style.background = "var(--btn)";
                authBtn.onclick = () => {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    // å¼·åˆ¶æ”¹ç”¨å½ˆå‡ºè¦–çª—
                    auth.signInWithPopup(provider)
                        .then((result) => {
                            console.log("ç™»å…¥æˆåŠŸï¼");
                        })
                        .catch((err) => {
                            console.error("Popup éŒ¯èª¤è©³æƒ…ï¼š", err);
                        });
                };
            }
        });

        // 4. å„²å­˜è¨­å®šæŒ‰éˆ• (å¯è¦–éœ€æ±‚åŠ å…¥å­˜åˆ° Firestore çš„åŠŸèƒ½)
        saveKeyBtn.onclick = async () => {
            const settings = {
                gptApiKey: keyInput.value,
                userLang: langSelect.value,
                userCourse: courseSelect.value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp() // ç´€éŒ„æ›´æ–°æ™‚é–“
            };

            // 1. å„²å­˜åˆ°æœ¬åœ° (ç¢ºä¿é›¢ç·šå¯ç”¨)
            localStorage.setItem('gptApiKey', settings.gptApiKey);
            localStorage.setItem('userLang', settings.userLang);
            localStorage.setItem('userCourse', settings.userCourse);

            // 2. å„²å­˜åˆ°é›²ç«¯ Firestore (æ ¸å¿ƒä¿®æ­£)
            const user = auth.currentUser;
            if (user) {
                try {
                    await db.collection('users').doc(user.uid).set(settings, { merge: true });
                    alert('âœ… é›²ç«¯åŒæ­¥æˆåŠŸï¼');
                } catch (e) {
                    console.error("é›²ç«¯åŒæ­¥å¤±æ•—:", e);
                    alert('âŒ å„²å­˜å¤±æ•—ï¼šè«‹æª¢æŸ¥ Firestore æ¬Šé™è¨­å®š');
                }
            } else {
                alert('âš ï¸ æœªç™»å…¥ï¼Œè¨­å®šåƒ…å„²å­˜æ–¼æ­¤ç€è¦½å™¨ã€‚');
            }
        };
    </script>
</body>

</html>