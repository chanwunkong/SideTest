<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>ÂñÆÂ≠óÊâãÂØ´Á∑¥Áøí</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg: #0b1220;
            --card: #111827;
            --text: #e5e7eb;
            --accent: #22d3ee;
            --btn: #0ea5e9;
            --danger: #ef4444;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: sans-serif;
            padding: 20px;
        }

        .wrap {
            max-width: 680px;
            margin: 0 auto;
        }

        .app {
            background: var(--card);
            border: 1px solid #1f2937;
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #334155;
            padding-bottom: 10px;
        }

        textarea {
            width: 100%;
            border-radius: 14px;
            background: #0b1220;
            color: var(--accent);
            padding: 14px;
            font-size: 32px;
            font-weight: bold;
            border: 1px solid #1f2937;
            text-align: center;
            resize: none;
        }

        canvas {
            width: 100%;
            height: 45vh;
            background: #0b1220;
            border-radius: 16px;
            touch-action: none;
            margin-top: 15px;
            border: 1px solid #334155;
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            max-height: 150px;
            overflow-y: auto;
            padding: 5px;
        }

        .chip {
            padding: 8px 15px;
            border-radius: 999px;
            background: #1f2937;
            color: #cbd5e1;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
        }

        .chip:hover {
            border-color: var(--accent);
            background: #2d3748;
        }

        .chip small {
            display: block;
            font-size: 10px;
            color: #fbbf24;
            text-align: center;
        }

        .pad-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            flex: 1;
            border-radius: 14px;
            padding: 15px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: 0.2s;
        }

        .primary {
            background: var(--btn);
            color: #000;
        }

        .danger {
            background: var(--danger);
            color: #fff;
        }

        #ipa {
            color: var(--accent);
            text-align: center;
            font-size: 20px;
            margin: 10px 0;
            min-height: 1.2em;
            font-family: monospace;
        }

        .back-link {
            color: var(--accent);
            text-decoration: none;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="app">
            <div class="header">
                <a href="index.html" class="back-link">‚Üê ÊéßÂà∂‰∏≠ÂøÉ</a>
                <div id="status" style="font-size: 12px; color: #94a3b8;">ËºâÂÖ•‰∏≠...</div>
            </div>

            <div class="chips" id="samples"></div>

            <textarea id="text" readonly placeholder="ÈªûÊìä‰∏äÊñπÂñÆÂ≠óÈñãÂßã"></textarea>
            <div id="ipa"></div>

            <canvas id="pad"></canvas>

            <div class="pad-actions">
                <button class="danger" id="clearBtn">üßπ Ê∏ÖÈô§</button>
                <button class="primary" id="speakBtn">‚ñ∂ ÊúóËÆÄ‰∏¶Êü•Ë©¢</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBqZLFskqgyiAEc127dh95rXsOPQVLSurM", authDomain: "test-5dbba.firebaseapp.com", projectId: "test-5dbba" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // üí° 1. Âº∑Âà∂ËÆÄÂèñÊéßÂà∂‰∏≠ÂøÉË®≠ÂÆö
        const getGlobalSettings = () => ({
            lang: localStorage.getItem('userLang') || 'en-US',
            course: localStorage.getItem('userCourse') || 'all',
            key: localStorage.getItem('gptApiKey') || ''
        });

        const canvas = document.getElementById('pad');
        const ctx = canvas.getContext('2d');
        const textEl = document.getElementById('text');
        const ipaEl = document.getElementById('ipa');
        const samplesEl = document.getElementById('samples');

        let userId = null;
        let allWordData = [];
        let isDrawing = false;

        // üí° 2. ÂàùÂßãÂåñÔºöÁ¢∫‰øùË≥áÊñôËÆÄÂèñËàáÊ∏≤Êüì
        auth.onAuthStateChanged(user => {
            userId = user ? user.uid : null;
            document.getElementById('status').textContent = user ? `Â≠∏ÁøíËÄÖÔºö${user.email.split('@')[0]}` : "Â∞öÊú™ÁôªÂÖ•";
            loadSwadeshCSV();
        });

        async function loadSwadeshCSV() {
            try {
                const resp = await fetch('swadesh.csv');
                if (!resp.ok) throw new Error("CSV not found");
                const csvText = await resp.text();

                // Â∞áË≥áÊñôÂ≠òÂÖ• renderChips ÊúÉËÆÄÂèñÁöÑÂÖ®ÂüüËÆäÊï∏
                window.allWordData = Papa.parse(csvText, { header: true }).data;

                renderChips(); // Ë≥áÊñôËºâÂÖ•ÂæåÁ´ãÂç≥Ê∏≤Êüì
            } catch (e) {
                console.error("CSV Âä†ËºâÈåØË™§:", e);
            }
        }

        // üí° 3. ÂñÆÂ≠óÊ∏≤ÊüìËàá Stage ÈÅéÊøæ
        async function renderChips() {
            if (!window.allWordData) return;
            const settings = getGlobalSettings();
            const samplesEl = document.getElementById('samples');

            // ËÆÄÂèñÁÜüÁ∑¥Â∫¶ (ÊòüÊòü)
            let masteryMap = {};
            if (userId) {
                try {
                    const snap = await db.collection('users').doc(userId).collection('mastery')
                        .where('lang', '==', settings.lang).get();
                    snap.forEach(doc => masteryMap[doc.data().word] = doc.data().count);
                } catch (e) { console.error("ËÆÄÂèñÁÜüÁ∑¥Â∫¶Â§±Êïó", e); }
            }

            samplesEl.innerHTML = '';
            const stageFilter = settings.course; // ÈÄôË£°ÊúÉÊäìÂà∞ "Stage 1" Á≠âÂ≠ó‰∏≤

            window.allWordData.forEach((row) => {
                const word = row[settings.lang];
                const rowStage = row['Stage']; // ÂèñÂæó CSV ‰∏≠ÁöÑ Stage Ê¨Ñ‰Ωç

                // ‰øÆÊîπÂæåÁöÑÂà§Êñ∑ÈÇèËºØ
                if (word && (stageFilter === 'all' || rowStage === stageFilter)) {
                    const chip = document.createElement('div');
                    chip.className = 'chip';

                    const count = masteryMap[word] || 0;
                    const stars = '‚≠ê'.repeat(Math.min(count, 3));

                    chip.innerHTML = `${word}<small style="display:block; font-size:10px; opacity:0.6;">${stars || '‚òÜ‚òÜ‚òÜ'}</small>`;

                    chip.onclick = () => {
                        document.getElementById('text').value = word;
                        if (typeof redraw === 'function') redraw();
                        speakAndFetchIPA(word);
                        updateWordMastery(word);
                    };
                    samplesEl.appendChild(chip);
                }
            });
        }
        
        // üí° 4. IPA Êü•Ë©¢ÂäüËÉΩÂõûÊ≠∏ (Â∞çÊé•Âø´ÂèñËàá OpenAI)
        async function speakAndFetchIPA(word) {
            const settings = getGlobalSettings();

            // Ë™ûÈü≥ÊúóËÆÄ
            const u = new SpeechSynthesisUtterance(word);
            u.lang = settings.lang;
            speechSynthesis.cancel();
            speechSynthesis.speak(u);

            // IPA Êü•Ë©¢
            ipaEl.textContent = "üîç IPA Êü•Ë©¢‰∏≠...";
            const cacheId = `${settings.lang}_${word}`.replace(/[\/\.#$\[\]]/g, '_');

            try {
                // ÂÖàÊü•Âø´Âèñ
                const cacheDoc = await db.collection('ipa_cache').doc(cacheId).get();
                if (cacheDoc.exists) {
                    ipaEl.textContent = `[ ${cacheDoc.data().ipa} ]`;
                    return;
                }

                // ÁÑ°Âø´ÂèñÂâáÊü• OpenAI
                if (!settings.key) {
                    ipaEl.textContent = "Ë´ãÂÖàË®≠ÂÆö API Key ‰ª•È°ØÁ§∫ IPA";
                    return;
                }

                const resp = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${settings.key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [{ role: "user", content: `Provide the IPA for "${word}" in ${settings.lang}. Output IPA only.` }]
                    })
                });
                const result = await resp.json();
                const ipaText = result.choices[0].message.content.trim();

                // Â≠òÂÖ•Âø´Âèñ
                await db.collection('ipa_cache').doc(cacheId).set({ ipa: ipaText, lang: settings.lang });
                ipaEl.textContent = `[ ${ipaText} ]`;
            } catch (e) {
                ipaEl.textContent = "IPA ÂèñÂæóÂ§±Êïó";
            }
        }

        async function updateWordMastery(word) {
            if (!userId) return;
            const settings = getGlobalSettings();
            const wordId = btoa(unescape(encodeURIComponent(`${settings.lang}_${word}`))).substring(0, 50);
            const wordRef = db.collection('users').doc(userId).collection('mastery').doc(wordId);

            await wordRef.set({
                word: word,
                lang: settings.lang,
                count: firebase.firestore.FieldValue.increment(1),
                lastStudied: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            const doc = await wordRef.get();
            if (doc.data().count >= 3) {
                await wordRef.update({ is_ready_for_chunk: true });
            }
            renderChips(); // Âç≥ÊôÇÊõ¥Êñ∞ÊòüÊòü
        }

        // üí° 5. Áï´Â∏ÉÈÇèËºØ (Á∞°Âåñ‰∏¶ÊîØÊè¥Ëá™ÈÅ©Êáâ)
        function initCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width; canvas.height = rect.height;
            ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.strokeStyle = '#22d3ee';
        }

        canvas.onpointerdown = (e) => { isDrawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); };
        canvas.onpointermove = (e) => { if (isDrawing) ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); };
        canvas.onpointerup = () => isDrawing = false;
        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
        document.getElementById('clearBtn').onclick = clearCanvas;
        document.getElementById('speakBtn').onclick = () => speakAndFetchIPA(textEl.value);

        window.onload = () => { initCanvas(); };
    </script>
</body>

</html>