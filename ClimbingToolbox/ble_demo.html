<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WH-C06 數據解析器 V2</title>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        button { padding: 12px 24px; font-size: 16px; border: none; cursor: pointer; margin-right: 10px; color: #fff; background-color: #00bcd4; border-radius: 4px;}
        button:disabled { background-color: #555; cursor: not-allowed; }
        #btn-stop { background-color: #f44336; }
        #data-display { background-color: #1e1e1e; padding: 20px; margin-top: 20px; border-radius: 8px; border: 1px solid #333; }
        .data-row { font-family: monospace; font-size: 18px; color: #4CAF50; letter-spacing: 2px; margin-bottom: 10px;}
        .highlight { color: #FF9800; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>WH-C06 數據解析器 V2</h2>
    <p>已經加入 Company ID 解鎖，現在應該能看到真實的 16 進位數據了。</p>

    <div>
        <button id="btn-scan">掃描並連線 IF_B7</button>
        <button id="btn-stop" disabled>停止</button>
    </div>

    <div id="data-display">
        <div style="color:#888; font-size:14px; margin-bottom:10px;">即時 Hex 數據流：</div>
        <div id="raw-hex" class="data-row">等待數據...</div>
    </div>
</div>

<script>
    const btnScan = document.getElementById('btn-scan');
    const btnStop = document.getElementById('btn-stop');
    const rawHexDisplay = document.getElementById('raw-hex');
    let bluetoothDevice;

    // 我們從 nRF Connect 找到的製造商 ID
    const TARGET_COMPANY_ID = 0x0100; 

    async function startScanning() {
        try {
            rawHexDisplay.textContent = '請求設備中...';
            
            // 關鍵修改：明確要求允許讀取 0x0100 的 Manufacturer Data
            bluetoothDevice = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalManufacturerData: [TARGET_COMPANY_ID] 
            });

            bluetoothDevice.addEventListener('advertisementreceived', handleAdvertisement);

            rawHexDisplay.textContent = '啟動監聽中...';
            await bluetoothDevice.watchAdvertisements();
            
            btnScan.disabled = true;
            btnStop.disabled = false;

        } catch (error) {
            rawHexDisplay.textContent = `錯誤: ${error.message}`;
            rawHexDisplay.style.color = '#f44336';
        }
    }

    function handleAdvertisement(event) {
        // 檢查是否包含我們指定的 Manufacturer Data
        if (event.manufacturerData && event.manufacturerData.has(TARGET_COMPANY_ID)) {
            const dataView = event.manufacturerData.get(TARGET_COMPANY_ID);
            
            // 將 DataView 轉成 16 進位字串 (例如: 02 03 11 2A C0...)
            let hexArray = Array.from(new Uint8Array(dataView.buffer))
                .map(b => b.toString(16).padStart(2, '0').toUpperCase());
            
            // 更新到畫面上
            rawHexDisplay.textContent = hexArray.join(' ');
            rawHexDisplay.style.color = '#4CAF50';
        }
    }

    async function stopScanning() {
        if (bluetoothDevice) {
            bluetoothDevice.removeEventListener('advertisementreceived', handleAdvertisement);
            try { await bluetoothDevice.unwatchAdvertisements(); } catch(e){}
        }
        rawHexDisplay.textContent = '已停止監聽。';
        btnScan.disabled = false;
        btnStop.disabled = true;
    }

    btnScan.addEventListener('click', startScanning);
    btnStop.addEventListener('click', stopScanning);
</script>

</body>
</html>