<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’æ§åˆ¶ä¸­å¿ƒ</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, sans-serif;
        }

        body {
            background-color: #0b1220;
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card {
            background: #111827;
            width: 100%;
            max-width: 500px;
            padding: 20px;
            border-radius: 20px;
            border: 1px solid #1f2937;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #22d3ee;
            text-align: center;
        }

        label {
            font-size: 13px;
            color: #cbd5e1;
            margin-top: 15px;
            display: block;
        }

        select,
        input,
        button {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            border-radius: 12px;
            border: 1px solid #1f2937;
            background: #0b1220;
            color: white;
            font-size: 16px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 500px;
        }

        .nav-box {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-decoration: none;
            font-weight: bold;
            border-radius: 15px;
            aspect-ratio: 1/1;
            transition: 0.2s;
        }

        .box-0 {
            background: #007AFF;
        }

        .box-1 {
            background: #34C759;
        }

        .box-2 {
            background: #ff7b00;
        }

        .box-3 {
            background: #ff0000;
        }

        .hidden {
            display: none !important;
        }

        #statusMsg {
            font-size: 12px;
            color: #22d3ee;
            margin-top: 8px;
            text-align: center;
            display: block;
        }
    </style>
</head>

<body>
    <h1>å­¸ç¿’æ§åˆ¶ä¸­å¿ƒ</h1>
    <div class="card">
        <div id="loginSection">
            <button id="loginBtn" style="background: #0ea5e9; color: #000; font-weight: bold;">ä½¿ç”¨ Google ç™»å…¥åŒæ­¥</button>
        </div>
        <div id="logoutSection" class="hidden">
            <p id="userInfo" style="font-size:12px; text-align:center; color:#aaa;"></p>
            <button id="logoutBtn"
                style="background: #ef4444; color: white; padding: 8px; font-size: 12px; margin-top:8px;">ç™»å‡ºå¸³è™Ÿ</button>
        </div>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #1f2937;">

        <div class="field">
            <label class="label">OpenAI API Key (ç”¨æ–¼ IPA èˆ‡ AI å‡ºé¡Œ)</label>
            <div style="display: flex; gap: 10px;">
                <input type="password" id="gptApiKey" placeholder="å·²å¾é›²ç«¯åŒæ­¥ sk-..." disabled
                    style="flex: 1; opacity: 0.6; cursor: not-allowed;">
                <button id="unlockBtn" onclick="toggleUnlock()"
                    style="width: 80px; background: #22d3ee; color: #000;">ğŸ”“ è§£é–</button>
            </div>
        </div>
        <button id="saveKeyBtn" style="background: #22d3ee; color: #000; font-weight: bold;">å„²å­˜æ‰€æœ‰è¨­å®š</button>
        <span id="statusMsg"></span>

        <label>ç›®æ¨™å­¸ç¿’èªè¨€</label>
        <select id="globalLang">
            <option value="en-US">English ğŸ‡ºğŸ‡¸</option>
            <option value="it-IT">Italiano ğŸ‡®ğŸ‡¹</option>
            <option value="zh-TW">ä¸­æ–‡ (ç¹é«”) ğŸ‡¹ğŸ‡¼</option>
            <option value="ja-JP">æ—¥æœ¬èª ğŸ‡¯ğŸ‡µ</option>
        </select>

        <label>å­¸ç¿’èª²ç¨‹é€²åº¦</label>
        <select id="globalCourse">
            <option value="all">å…¨éƒ¨å–®å­—</option>
            <option value="Stage 1">Stage 1: Core 40</option>
            <option value="Stage 2">Stage 2: Swadesh</option>
        </select>
    </div>

    <div class="grid">
        <a href="test0.html" class="nav-box box-0"><span>ğŸ‘„ IPAéŸ³æ¨™</span></a>
        <a href="test1.html" class="nav-box box-1"><span>âœï¸ æ‰‹å¯«ç·´ç¿’</span></a>
        <a href="test2.html" class="nav-box box-2"><span>ğŸ§© èªå¡Šæ’åº</span></a>
        <a href="test3.html" class="nav-box box-3"><span>ğŸ¤· æƒ…å¢ƒ</span></a>
    </div>

    <script>
        // --- 1. é…ç½®èˆ‡åˆå§‹åŒ– ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqZLFskqgyiAEc127dh95rXsOPQVLSurM",
            authDomain: "test-5dbba.firebaseapp.com",
            projectId: "test-5dbba"
        };

        // å•Ÿå‹•æ™‚ç«‹åˆ»å­˜å…¥ localStorage ä¾›åˆ†é æŠ“å–
        localStorage.setItem('firebaseConfig', JSON.stringify(firebaseConfig));
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();

        let isDataLoaded = false;
        let isUnlocked = false;

        const keyInput = document.getElementById('gptApiKey');
        const langInput = document.getElementById('globalLang');
        const courseInput = document.getElementById('globalCourse');

        // --- 2. ä»‹é¢æ§åˆ¶å‡½å¼ ---
        function toggleUnlock() {
            if (!isDataLoaded) {
                alert("è³‡æ–™åŒæ­¥ä¸­ï¼Œè«‹ç¨å€™...");
                return;
            }
            const btn = document.getElementById('unlockBtn');
            isUnlocked = !isUnlocked;
            if (isUnlocked) {
                keyInput.disabled = false;
                keyInput.type = "text";
                keyInput.style.opacity = "1";
                keyInput.style.cursor = "text";
                btn.textContent = "ğŸ”’ é–å®š";
                btn.style.background = "#94a3b8";
            } else {
                keyInput.disabled = true;
                keyInput.type = "password";
                keyInput.style.opacity = "0.6";
                keyInput.style.cursor = "not-allowed";
                btn.textContent = "ğŸ”“ è§£é–";
                btn.style.background = "#22d3ee";
            }
        }

        async function saveSettings() {
            if (!isDataLoaded) return;
            const key = isUnlocked ? keyInput.value.trim() : localStorage.getItem('gptApiKey');
            const lang = langInput.value;
            const course = courseInput.value;

            if (isUnlocked) localStorage.setItem('gptApiKey', key);
            localStorage.setItem('userLang', lang);
            localStorage.setItem('userCourse', course);

            const user = auth.currentUser;
            if (user) {
                try {
                    const updateData = {
                        userLang: lang,
                        userCourse: course,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    if (isUnlocked) updateData.gptApiKey = key;
                    await db.collection('users').doc(user.uid).set(updateData, { merge: true });
                    alert("é›²ç«¯åŒæ­¥æˆåŠŸï¼");
                } catch (e) {
                    alert("å„²å­˜å¤±æ•—ï¼š" + e.message);
                }
            } else {
                alert("å·²å„²å­˜è‡³æœ¬åœ°");
            }
        }

        // --- 3. ç™»å…¥ç‹€æ…‹ç›£è½ ---
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('logoutSection').classList.remove('hidden');
                document.getElementById('userInfo').textContent = `ç™»å…¥ä¸­: ${user.email}`;
                keyInput.placeholder = "é›²ç«¯åŒæ­¥ä¸­...";

                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.gptApiKey) {
                            keyInput.value = data.gptApiKey;
                            localStorage.setItem('gptApiKey', data.gptApiKey);
                        }
                        if (data.userLang) langInput.value = data.userLang;
                        if (data.userCourse) courseInput.value = data.userCourse;
                    }
                    isDataLoaded = true;
                    keyInput.placeholder = "å·²åŒæ­¥ (é»æ“Šè§£é–ä¿®æ”¹)";
                });
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('logoutSection').classList.add('hidden');
                keyInput.value = localStorage.getItem('gptApiKey') || '';
                isDataLoaded = true;
            }
        });

        document.getElementById('loginBtn').onclick = () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider);
        };

        // --- ä¿®æ­£å¾Œçš„ç™»å‡ºæŒ‰éˆ•é‚è¼¯ ---
        document.getElementById('logoutBtn').onclick = async () => {
            try {
                // 1. å…ˆåŸ·è¡Œ Firebase ç™»å‡º
                await auth.signOut();

                // 2. æ¸…é™¤æ‰€æœ‰æœ¬åœ°æš«å­˜ (åŒ…å« API Config èˆ‡ Key)
                localStorage.clear();
                sessionStorage.clear();

                // 3. å¼·åˆ¶è·³è½‰/é‡æ–°æ•´ç†ï¼Œç¢ºä¿æ‰€æœ‰ç‹€æ…‹é‡ç½®
                console.log("âœ… å·²æˆåŠŸç™»å‡ºä¸¦æ¸…ç†æš«å­˜");
                window.location.reload();
            } catch (error) {
                console.error("âŒ ç™»å‡ºå¤±æ•—:", error);
                alert("ç™»å‡ºéç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
        };

        // ç¢ºä¿å…¶ä»–æŒ‰éˆ•ç¶å®šæ­£ç¢ºï¼Œä¸è¦è“‹åˆ° logoutBtn
        document.getElementById('saveKeyBtn').onclick = saveSettings;
        document.getElementById('globalLang').onchange = saveSettings;
        document.getElementById('globalCourse').onchange = saveSettings;
        langInput.onchange = saveSettings;
        courseInput.onchange = saveSettings;
    </script>
</body>

</html>