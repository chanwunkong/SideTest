<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>AI èªå¡Šèªæ³•æ’åºç·´ç¿’ v2.9</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <script src="config.js"></script>
    <script src="prompts.js"></script>
    <link rel="stylesheet" href="style.css">

    <style>
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        #feedback {
            text-align: center;
            margin: 15px 0;
            min-height: 24px;
            font-weight: bold;
            color: var(--accent);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="nav-header">
            <a href="index.html" class="back-link">â† è¿”å›æ§åˆ¶ä¸­å¿ƒ</a>
            <span id="langDisplay" style="font-size: 12px; color: #94a3b8;">è¼‰å…¥ä¸­...</span>
            <span id="stageDisplay" style="font-size: 12px; color: var(--accent); margin-left:10px;"></span>
        </div>

        <h2 style="text-align: center; margin: 0 0 20px 0;">AI èªå¡Šèªæ³•ç·´ç¿’</h2>

        <div class="controls">
            <button class="btn-ai" id="nextBtn" style="flex:2">âœ¨ ç”Ÿæˆæ–°é¡Œç›®</button>
            <button class="btn-img" id="genImageBtn" disabled style="flex:1">ğŸ¨ ç”Ÿåœ–</button>
        </div>

        <button id="playBtn"
            style="width: 100%; background: #1e293b; color: white; margin-bottom: 15px; border-radius: 12px; padding: 10px; border:none;">ğŸ”Š
            æ’­æ”¾æ•´å¥èªéŸ³</button>

        <div id="feedback"></div>
        <div class="sentence-display" id="workspace"></div>
        <div class="pool" id="wordPool"></div>

        <button class="btn-check" id="checkBtn">é€å‡ºæª¢æŸ¥</button>
        <div id="analysisPane"></div>

        <div class="history-section">
            <h3 style="font-size: 16px; margin-bottom: 15px; color: #22d3ee;">ğŸ“š æœ€è¿‘ç·´ç¿’ç´€éŒ„</h3>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        let currentSentenceData = null;

        // å¾¹åº•ä¿®å¾©ï¼šéæ¿¾é ISO-8859-1 å­—å…ƒ
        function getActiveSettings() {
            let rawKey = localStorage.getItem('gptApiKey') || "";
            // æ­£è¦è¡¨é”å¼ç§»é™¤æ‰€æœ‰é ASCII å­—å…ƒ
            const cleanKey = rawKey.replace(/[^\x00-\x7F]/g, "").trim();

            return {
                key: cleanKey,
                lang: localStorage.getItem('userLang') || 'en-US',
                course: localStorage.getItem('userCourse') || 'Stage 1'
            };
        }

        function initPage() {
            const settings = getActiveSettings();
            document.getElementById('langDisplay').textContent = `ç›®æ¨™èªè¨€ï¼š${settings.lang}`;
            document.getElementById('stageDisplay').textContent = `é›£åº¦ï¼š${settings.course}`;
        }

        initPage();

        function speak(text) {
            if (!text) return;
            speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = getActiveSettings().lang;
            speechSynthesis.speak(u);
        }

        async function getNextExercise() {
            const settings = getActiveSettings();
            if (!settings.key) return alert("è«‹å…ˆè¨­å®š API Keyï¼");

            resetUI();
            document.getElementById('feedback').textContent = "ğŸ“¡ æ­£åœ¨èª¿ç”¨èªå¡Šå”è­°...";

            try {
                // å¾ prompts.js ç²å–æŒ‡ä»¤
                const prompt = CHUNK_PROMPTS.getTest2Prompt(settings.lang, settings.course);

                const resp = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${settings.key}`, // å·²æ¸…æ½”éçš„ Key
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [{ role: "user", content: prompt }],
                        response_format: { type: "json_object" }
                    })
                });

                const result = await resp.json();
                if (result.error) throw new Error(result.error.message);

                const data = JSON.parse(result.choices[0].message.content);
                currentSentenceData = data;
                renderGame(data);
                document.getElementById('feedback').textContent = "âœ… èªå¡Šè¼‰å…¥å®Œæˆ";
            } catch (e) {
                document.getElementById('feedback').textContent = "âŒ éŒ¯èª¤: " + e.message;
            }
        }

        function renderGame(data) {
            const pool = document.getElementById('wordPool');
            const shuffled = [...data.chunks].sort(() => Math.random() - 0.5);
            const labels = { 'noun': 'åè©', 'verb': 'å‹•è©', 'adj': 'å½¢å®¹', 'adv': 'å‰¯è©', 'other': 'çµæ§‹' };

            shuffled.forEach(item => {
                const chip = document.createElement('div');
                chip.className = `word-chip pos-${item.type}`;
                chip.innerHTML = `${item.text}<small>${labels[item.type] || 'çµ„å¡Š'}</small>`;
                chip.onclick = () => {
                    const target = chip.parentElement.id === 'wordPool' ? 'workspace' : 'wordPool';
                    if (target === 'workspace') speak(item.text);
                    document.getElementById(target).appendChild(chip);
                };
                pool.appendChild(chip);
            });
        }

        document.getElementById('checkBtn').onclick = () => {
            if (!currentSentenceData) return;
            const workspace = document.getElementById('workspace');
            const userOrder = Array.from(workspace.children).map(c => c.childNodes[0].textContent.trim());
            const correctOrder = currentSentenceData.chunks.map(c => c.text);

            if (JSON.stringify(userOrder) === JSON.stringify(correctOrder)) {
                document.getElementById('feedback').textContent = "ğŸ‰ å”è­°é”æˆï¼";
                workspace.classList.add('correct');
                speak(currentSentenceData.sentence);
                document.getElementById('analysisPane').style.display = 'block';
                document.getElementById('analysisPane').innerHTML = `<b>è§£æï¼š</b><br>` +
                    currentSentenceData.chunks.map(c => `<b>${c.text}</b>: ${c.analysis}`).join('<br>');
            } else {
                document.getElementById('feedback').textContent = "âŒ èªåºä¸åŒ¹é…";
            }
        };

        function resetUI() {
            document.getElementById('workspace').innerHTML = "";
            document.getElementById('workspace').classList.remove('correct');
            document.getElementById('wordPool').innerHTML = "";
            document.getElementById('analysisPane').style.display = 'none';
        }

        new Sortable(document.getElementById('workspace'), { animation: 150 });
        document.getElementById('nextBtn').onclick = getNextExercise;
        document.getElementById('playBtn').onclick = () => speak(currentSentenceData?.sentence);
    </script>
</body>

</html>