<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>AI èªå¡Šèªæ³•æ’åºç·´ç¿’ v2.5</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <script src="config.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ç¹¼æ‰¿ test3 çš„è©æ€§è‘—è‰²é‚è¼¯ */
        .word-chip.pos-noun {
            background: var(--pos-noun);
            border-bottom: 4px solid #1d4ed8;
        }

        .word-chip.pos-adj {
            background: var(--pos-adj);
            border-bottom: 4px solid #15803d;
        }

        .word-chip.pos-verb {
            background: var(--pos-verb);
            border-bottom: 4px solid #b91c1c;
        }

        .word-chip.pos-adv {
            background: var(--pos-adv);
            border-bottom: 4px solid #b45309;
        }

        .word-chip.pos-other {
            background: var(--pos-other);
            border-bottom: 4px solid #ca8a04;
            color: #000;
            /* é»ƒè‰²èƒŒæ™¯æ­é…é»‘è‰²æ–‡å­—è¼ƒæ˜“é–±è®€ */
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="nav-header">
            <a href="index.html" class="back-link">â† è¿”å›æ§åˆ¶ä¸­å¿ƒ</a>
            <span id="langDisplay" style="font-size: 12px; color: #94a3b8;">è¼‰å…¥ä¸­...</span>
            <span id="stageDisplay" style="font-size: 12px; color: var(--accent); margin-left:10px;"></span>
        </div>
        <h2 style="text-align: center; margin: 0 0 20px 0;">AI èªå¡Šèªæ³•ç·´ç¿’</h2>
        <div class="controls">
            <button class="btn-ai" id="nextBtn">âœ¨ ç”Ÿæˆæ–°é¡Œç›®</button>
            <button class="btn-img" id="genImageBtn" disabled>ğŸ¨ ç”Ÿåœ–</button>
        </div>
        <button class="btn-play" id="playBtn">ğŸ”Š æ’­æ”¾æ•´å¥èªéŸ³</button>
        <div id="imageContainer" style="display:none; text-align:center; margin:15px 0;">
            <img id="generatedImage"
                style="max-width:100%; border-radius:20px; box-shadow:0 10px 20px rgba(0,0,0,0.5);">
        </div>
        <div id="feedback"></div>
        <div class="sentence-display" id="workspace"></div>
        <div class="pool" id="wordPool"></div>
        <button class="btn-check" id="checkBtn">é€å‡ºæª¢æŸ¥</button>
        <div id="analysisPane"></div>
        <div class="history-section">
            <h3 style="font-size: 16px; margin-bottom: 15px; color: #22d3ee;">ğŸ“š æœ€è¿‘ç·´ç¿’ç´€éŒ„</h3>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        let currentSentenceData = null;
        let currentUserId = null;

        // åˆ†ç´šå”è­°å®šç¾©ï¼šæ±ºå®šèªå¡Šæ‹†åˆ†çš„é‚è¼¯
        const PROTOCOL_STAGES = {
            "Stage 1": "Survival level. Use ONLY Core 40 words from swadesh.csv (Nouns, Verbs, Pronouns, Numbers). Max 3 chunks.",
            "Stage 2": "Social. Simple phrases. Include Adjectives.",
            "Stage 3": "CEFR A1. Basic sentences, clear functional chunks.",
            "Stage 4": "CEFR A2. Longer chunks with Adverbs.",
            "Stage 5": "CEFR B1. Complex chunks with conjunctions.",
            "Stage 6": "CEFR B2. Sophisticated language chunks.",
            "Stage 7": "CEFR C1. Advanced professional chunks.",
            "Stage 8": "CEFR C2. Master level nuanced chunks."
        };

        function getActiveSettings() {
            return {
                key: localStorage.getItem('gptApiKey'),
                lang: localStorage.getItem('userLang') || 'en-US',
                course: localStorage.getItem('userCourse') || 'Stage 1'
            };
        }

        function initPage() {
            const settings = getActiveSettings();
            document.getElementById('langDisplay').textContent = `ç›®æ¨™èªè¨€ï¼š${settings.lang}`;
            document.getElementById('stageDisplay').textContent = `é›£åº¦ï¼š${settings.course}`;
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                loadHistory();
            }
        });

        initPage();

        function speak(text) {
            if (!text) return;
            const settings = getActiveSettings();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = settings.lang;
            speechSynthesis.cancel();
            speechSynthesis.speak(u);
        }

        async function getNextExercise() {
            const settings = getActiveSettings();
            if (!settings.key) return alert("è«‹å…ˆè¨­å®š API Keyï¼");

            resetUI();
            document.getElementById('feedback').textContent = "ğŸ” æ­£åœ¨æ ¹æ“šæ‚¨çš„ç­‰ç´šç”Ÿæˆèªå¡Šé¡Œç›®...";

            try {
                // æŠ“å–ç¨®å­å–®å­— (ç°¡åŒ–ç‰ˆï¼Œå¯¦éš›å¯åŠ å…¥ Firestore ç¯©é¸)
                const seeds = ["eat", "book", "water", "go"];

                const prompt = `
                Role: Language Teacher. 
                Task: Create a sentence in ${settings.lang} for ${settings.course}.
                Constraint: ${PROTOCOL_STAGES[settings.course]}
                Output JSON ONLY:
                {
                    "sentence": "Full sentence",
                    "chunks": [
                        {"text": "Meaningful chunk", "type": "noun/verb/adj/adv", "analysis": "è§£é‡‹"}
                    ]
                }`;

                const resp = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${settings.key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [{ role: "user", content: prompt }],
                        response_format: { type: "json_object" }
                    })
                });

                const result = await resp.json();
                const aiData = JSON.parse(result.choices[0].message.content);
                currentSentenceData = aiData;
                renderGame(aiData);
            } catch (e) {
                document.getElementById('feedback').textContent = "âŒ ç”Ÿæˆå¤±æ•—: " + e.message;
            }
        }

        function renderGame(data) {
            const workspace = document.getElementById('workspace');
            const pool = document.getElementById('wordPool');
            currentSentenceData.correctOrder = data.chunks.map(c => c.text);
            const shuffled = [...data.chunks].sort(() => Math.random() - 0.5);

            // èªå¡Šæ¨™ç±¤å®šç¾©
            const labels = { 'noun': 'åè©çµ„', 'verb': 'å‹•è©çµ„', 'adj': 'å½¢å®¹è©çµ„', 'adv': 'ä¿®é£¾èª' };

            shuffled.forEach(item => {
                const chip = document.createElement('div');
                chip.className = `word-chip pos-${item.type || 'other'}`;
                chip.innerHTML = `${item.text}<small>${labels[item.type] || 'çµ„å¡Š'}</small>`;
                chip.onclick = () => {
                    if (!chip.classList.contains('selected')) {
                        speak(item.text);
                        const clone = chip.cloneNode(true);
                        clone.onclick = () => { clone.remove(); chip.classList.remove('selected'); };
                        workspace.appendChild(clone);
                        chip.classList.add('selected');
                    }
                };
                pool.appendChild(chip);
            });
            document.getElementById('feedback').textContent = `[${getActiveSettings().course}] è«‹æ’åˆ—èªå¡Šé †åº`;
        }

        document.getElementById('checkBtn').onclick = () => {
            const userOrder = Array.from(document.getElementById('workspace').children).map(c => c.childNodes[0].textContent.trim());
            const success = JSON.stringify(userOrder) === JSON.stringify(currentSentenceData.correctOrder);
            if (success) {
                document.getElementById('feedback').textContent = "ğŸ‰ å”è­°é”æˆï¼èªåºæ­£ç¢º";
                document.getElementById('workspace').classList.add('correct');
                speak(currentSentenceData.sentence);
                document.getElementById('analysisPane').style.display = 'block';
                document.getElementById('analysisPane').innerHTML = `<b style="color:#22d3ee">ğŸ” è§£æï¼š</b><br>` + currentSentenceData.chunks.map(c => `<b>${c.text}</b>: ${c.analysis}`).join('<br>');
            } else {
                document.getElementById('feedback').textContent = "âŒ èªæ³•ä¸åŒ¹é…ï¼Œè«‹é‡æ–°æ’åˆ—";
            }
        };

        function resetUI() {
            document.getElementById('workspace').innerHTML = "";
            document.getElementById('workspace').classList.remove('correct');
            document.getElementById('wordPool').innerHTML = "";
            document.getElementById('analysisPane').style.display = 'none';
        }

        new Sortable(document.getElementById('workspace'), { animation: 150 });
        document.getElementById('nextBtn').onclick = getNextExercise;
        document.getElementById('playBtn').onclick = () => speak(currentSentenceData?.sentence);
    </script>
</body>

</html>