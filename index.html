<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èªè¨€ç·´ç¿’ - æ§åˆ¶ä¸­å¿ƒ</title>
    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <script src="config.js"></script>
    <style>

    </style>
</head>

<body>
    <div class="wrap">
        <div class="header">
            <span id="userEmail">æœªç™»å…¥</span>
        </div>

        <h1>å­¸ç¿’æ§åˆ¶ä¸­å¿ƒ</h1>

        <div class="card">
            <button id="authBtn">ä½¿ç”¨ Google ç™»å…¥</button>

            <label>GPT API KEY</label>
            <input type="password" id="gptApiKey" placeholder="sk-...">

            <label>ç›®æ¨™å­¸ç¿’èªè¨€</label>
            <select id="userLang">
                <option value="en-US">English ğŸ‡ºğŸ‡¸</option>
                <option value="it-IT">Italiano ğŸ‡®ğŸ‡¹</option>
                <option value="zh-TW">ä¸­æ–‡ (ç¹é«”) ğŸ‡¹ğŸ‡¼</option>
                <option value="ja-JP">æ—¥æœ¬èª ğŸ‡¯ğŸ‡µ</option>
                <option value="fr-FR">FranÃ§ais ğŸ‡«ğŸ‡·</option>
                <option value="de-DE">Deutsch ğŸ‡©ğŸ‡ª</option>
                <option value="es-ES">EspaÃ±ol ğŸ‡ªğŸ‡¸</option>
                <option value="pt-PT">PortuguÃªs ğŸ‡µğŸ‡¹</option>
                <option value="ru-RU">Ğ ÑƒÑÑĞºĞ¸Ğ¹ ğŸ‡·ğŸ‡º</option>
                <option value="hi-IN">à¤¹à¤¿à¤¨à¥à¤¦à¥€ / Ø§ÙØ±Ø¯ÙÙˆ ğŸ‡®ğŸ‡³</option>
                <option value="bn-BD">à¦¬à¦¾à¦‚à¦²à¦¾ ğŸ‡§ğŸ‡©</option>
                <option value="fa-IR">ÙØ§Ø±Ø³ÛŒ ğŸ‡®ğŸ‡·</option>
                <option value="ta-IN">à®¤à®®à®¿à®´à¯ ğŸ‡®ğŸ‡³</option>
                <option value="ar-SA">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ğŸ‡¸ğŸ‡¦</option>
                <option value="tr-TR">TÃ¼rkÃ§e ğŸ‡¹ğŸ‡·</option>
                <option value="ko-KR">í•œêµ­ì–´ ğŸ‡°ğŸ‡·</option>
                <option value="vi-VN">Tiáº¿ng Viá»‡t ğŸ‡»ğŸ‡³</option>
                <option value="id-ID">Bahasa Indonesia / Melayu ğŸ‡®ğŸ‡©</option>
                <option value="th-TH">à¹„à¸—à¸¢ ğŸ‡¹ğŸ‡­</option>
                <option value="sw-KE">Kiswahili ğŸ‡°ğŸ‡ª</option>
            </select>
            <label>å­¸ç¿’èª²ç¨‹é€²åº¦</label>
            <select id="userCourse">
                <option value="all">å…¨éƒ¨å–®å­—</option>
                <option value="Stage 1">Stage 1: æ ¸å¿ƒç”Ÿå­˜ (Core Survival)</option>
                <option value="Stage 2">Stage 2: åŸºç¤ç¤¾äº¤ (Basic Social)</option>
                <option value="Stage 3">Stage 3: A1 å…¥é–€ä»»å‹™ (Breakthrough)</option>
                <option value="Stage 4">Stage 4: A2 åˆç´šåŸºç¤ (Waystage)</option>
                <option value="Stage 5">Stage 5: B1 ä¸­ç´šé€²éš (Threshold)</option>
                <option value="Stage 6">Stage 6: B2 é«˜éšä¸­ç´š (Vantage)</option>
                <option value="Stage 7">Stage 7: C1 ç²¾é€šæµåˆ© (Effective Proficiency)</option>
                <option value="Stage 8">Stage 8: C2 æ¯èªç­‰ç´š (Mastery)</option>
            </select>

            <button id="saveKeyBtn" style="background: var(--btn); color: white; margin-top: 15px;">å„²å­˜è¨­å®š</button>
        </div>

        <div class="card" style="padding: 15px;">
            <div id="calendarHeader"
                style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                <h3 style="font-size: 16px; margin: 0;">ğŸ“… å­¸ç¿’è¶³è·¡ <span id="streakDisplay"
                        style="margin-left:10px; color:#fbbf24; font-size:14px;">ğŸ”¥ 0 å¤©</span></h3>
                <span id="toggleIcon">â–¼</span>
            </div>

            <div id="calendarCollapse" style="display: none; margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <button id="prevMonth" style="width: auto; padding: 5px 10px; margin: 0;">ï¼œ</button>
                    <span id="currentMonthLabel" style="font-weight: bold; color: var(--accent);">2026 / 02</span>
                    <button id="nextMonth" style="width: auto; padding: 5px 10px; margin: 0;">ï¼</button>
                </div>

                <div class="calendar-grid" id="calendarGrid"></div>
                <div id="dayDetail" style="font-size: 12px; color: var(--muted); margin-top: 10px; text-align: center;">
                    é»æ“Šæ—¥æœŸæŸ¥çœ‹ç´°ç¯€
                </div>
            </div>
        </div>

        <div class="grid">
            <a href="test0.html" class="nav-box box-0">éŸ³ä½è¨ºæ–·</a>
            <a href="test1.html" class="nav-box box-1">å–®å­—æ‰‹å¯«</a>
            <a href="test2.html" class="nav-box box-2">èªæ³•æ’åº</a>
            <a href="test3.html" class="nav-box box-3">å°è©±ç·´ç¿’</a>
        </div>
    </div>

    <script>
        const authBtn = document.getElementById('authBtn');
        const saveKeyBtn = document.getElementById('saveKeyBtn');
        const userEmailSpan = document.getElementById('userEmail');
        const keyInput = document.getElementById('gptApiKey');
        const langSelect = document.getElementById('userLang');
        const courseSelect = document.getElementById('userCourse');

        let viewDate = new Date();
        let calendarStats = null; // null è¡¨ç¤ºå°šæœªåŠ è¼‰

        // åˆå§‹åŒ–
        function loadLocalSettings() {
            const settings = getGlobalSettings();
            if (keyInput) keyInput.value = settings.key;
            if (langSelect) langSelect.value = settings.lang;
            if (courseSelect) courseSelect.value = settings.course;
        }
        loadLocalSettings();

        // ç™»å…¥ç‹€æ…‹ç›£è½
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userEmailSpan.textContent = user.email;
                authBtn.textContent = "ç™»å‡ºå¸³è™Ÿ";
                authBtn.style.background = "#ff4d4d";
                authBtn.onclick = () => auth.signOut();

                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.gptApiKey) { keyInput.value = data.gptApiKey; localStorage.setItem('gptApiKey', data.gptApiKey); }
                        if (data.userLang) { langSelect.value = data.userLang; localStorage.setItem('userLang', data.userLang); }
                        if (data.userCourse) { courseSelect.value = data.userCourse; localStorage.setItem('userCourse', data.userCourse); }
                    }
                } catch (e) { console.error(e); }

                calendarStats = null; // é‡ç½®æ•¸æ“šä»¥é‡æ–°æŠ“å–
                renderIndexCalendar();
            } else {
                userEmailSpan.textContent = "æœªç™»å…¥";
                authBtn.textContent = "ä½¿ç”¨ Google ç™»å…¥";
                authBtn.style.background = "var(--btn)";
                authBtn.onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
                calendarStats = {};
                renderIndexCalendar();
            }
        });

        // æŠ˜ç–ŠåŠŸèƒ½
        const calendarHeader = document.getElementById('calendarHeader');
        const calendarCollapse = document.getElementById('calendarCollapse');
        const toggleIcon = document.getElementById('toggleIcon');

        calendarHeader.onclick = () => {
            const isHidden = calendarCollapse.style.display === 'none';
            calendarCollapse.style.display = isHidden ? 'block' : 'none';
            toggleIcon.textContent = isHidden ? 'â–²' : 'â–¼';
            if (isHidden) renderIndexCalendar();
        };

        // æœˆä»½åˆ‡æ›
        document.getElementById('prevMonth').onclick = (e) => {
            e.stopPropagation();
            viewDate.setMonth(viewDate.getMonth() - 1);
            renderIndexCalendar();
        };

        document.getElementById('nextMonth').onclick = (e) => {
            e.stopPropagation();
            viewDate.setMonth(viewDate.getMonth() + 1);
            renderIndexCalendar();
        };

        // é€£å‹ç´€éŒ„
        function calculateStreak(stats) {
            let streak = 0;
            let checkDate = new Date();
            checkDate.setHours(0, 0, 0, 0);

            while (true) {
                const dateStr = checkDate.toISOString().split('T')[0];
                if (stats[dateStr] > 0) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    const todayStr = new Date().toISOString().split('T')[0];
                    if (dateStr === todayStr) {
                        checkDate.setDate(checkDate.getDate() - 1);
                        continue;
                    }
                    break;
                }
            }
            document.getElementById('streakDisplay').textContent = `ğŸ”¥ ${streak} å¤©`;
        }

        // æ ¸å¿ƒæ¸²æŸ“
        async function renderIndexCalendar() {
            const grid = document.getElementById('calendarGrid');
            const label = document.getElementById('currentMonthLabel');
            grid.innerHTML = "";

            const user = auth.currentUser;
            label.textContent = `${viewDate.getFullYear()} / ${String(viewDate.getMonth() + 1).padStart(2, '0')}`;

            // åƒ…åœ¨ç™»å…¥ä¸”æ•¸æ“šç‚ºç©ºæ™‚æŠ“å–ä¸€æ¬¡
            if (user && calendarStats === null) {
                calendarStats = {};
                const snap = await db.collection('users').doc(user.uid).collection('calendar').get();
                snap.forEach(doc => calendarStats[doc.id] = doc.data().count || 0);
                calculateStreak(calendarStats);
            }

            const stats = calendarStats || {};
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];

            // å¡«è£œç©ºç™½
            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // ç”Ÿæˆæ—¥æœŸ
            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const count = stats[dateStr] || 0;
                const isToday = dateStr === todayStr;

                const chip = document.createElement('div');
                chip.className = `date-chip ${isToday ? 'today' : ''}`;
                const stars = count > 0 ? 'â­'.repeat(Math.min(count, 3)) : '<span style="opacity:0.1">â˜†â˜†â˜†</span>';

                chip.innerHTML = `<span>${i}</span><div class="star-text">${stars}</div>`;
                chip.onclick = (e) => {
                    e.stopPropagation();
                    document.getElementById('dayDetail').textContent = `${dateStr}ï¼šç·´ç¿’äº† ${count} æ¬¡`;
                };
                grid.appendChild(chip);
            }
        }

        // å„²å­˜è¨­å®š
        saveKeyBtn.onclick = async () => {
            saveKeyBtn.disabled = true;
            saveKeyBtn.textContent = "å„²å­˜ä¸­...";
            const settings = {
                gptApiKey: keyInput.value.trim(),
                userLang: langSelect.value,
                userCourse: courseSelect.value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            localStorage.setItem('gptApiKey', settings.gptApiKey);
            localStorage.setItem('userLang', settings.userLang);
            localStorage.setItem('userCourse', settings.userCourse);

            if (auth.currentUser) {
                await db.collection('users').doc(auth.currentUser.uid).set(settings, { merge: true });
                alert('âœ… é›²ç«¯åŒæ­¥æˆåŠŸï¼');
            } else {
                alert('âš ï¸ é›¢ç·šå„²å­˜ã€‚');
            }
            saveKeyBtn.disabled = false;
            saveKeyBtn.textContent = "å„²å­˜è¨­å®š";
        };
    </script>
</body>

</html>