<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>å¤šèªæ‰‹å¯«æœ—è®€å·¥å…·</title>
    <meta name="theme-color" content="#0ea5e9" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b1220;
            --card: #111827;
            --muted: #6b7280;
            --text: #e5e7eb;
            --accent: #22d3ee;
            --btn: #0ea5e9;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: linear-gradient(180deg, #0b1220, #0f172a);
            color: var(--text);
            font-family: 'Noto Sans', sans-serif;
        }

        .wrap {
            max-width: 680px;
            margin: 0 auto;
            padding: clamp(16px, 5vw, 28px);
        }

        .app {
            background: linear-gradient(180deg, #0c1222, #0c1827);
            border: 1px solid #1f2937;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
        }

        header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid #1f2937;
            background: #0b1220;
        }

        .header-top {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        header .logo {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: radial-gradient(circle at 30% 30%, #22d3ee, #0ea5e9 60%, #0369a1);
        }

        .section {
            padding: 16px
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 14px
        }

        .label {
            font-size: 13px;
            color: #cbd5e1
        }

        textarea,
        select,
        input,
        input[type=range] {
            width: 100%;
            border-radius: 14px;
            border: 1px solid #1f2937;
            background: #0b1220;
            color: var(--text);
            padding: 14px;
            font-size: 16px;
            resize: vertical;
        }

        canvas {
            width: 100%;
            height: 50vh;
            background: #111827;
            border-radius: 16px;
            touch-action: none;
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 8px 0
        }

        .chip {
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid #1f2937;
            background: #0b1220;
            color: #cbd5e1;
            font-size: 13px;
            cursor: pointer;
        }

        button {
            flex: 1;
            border: none;
            border-radius: 14px;
            padding: 14px 16px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
        }

        .primary {
            background: var(--btn);
            color: #00111a
        }

        .danger {
            background: var(--danger);
            color: #fff
        }

        #ipa {
            color: #22d3ee;
            text-align: center;
            padding: 8px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 1.2em;
        }

        /* ---- ä¸¦æ’ row ---- */
        .row-fields {
            display: flex;
            flex-direction: row;
            gap: 16px;
            margin-bottom: 14px;
            flex-wrap: nowrap;
        }

        .row-fields .sub-field {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .pad-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .hidden {
            display: none !important;
        }

        #loginPanel {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: flex-start;
            margin-top: 10px;
        }

        #userInfo {
            font-size: 12px;
            color: var(--accent);
        }
    </style>
</head>

<body>

    <div class="wrap">
        <div class="app">
            <header>
                <div class="header-top">
                    <div class="logo" aria-hidden="true"></div>
                    <div>
                        <h1 style="margin:0;font-size:18px;">å¤šèªæ‰‹å¯«èªéŸ³å·¥å…·</h1>
                        <p style="margin:0;font-size:12px;color:#6b7280">æ”¯æ´æ‰‹å¯« + èªéŸ³ + IPA Â· Mobile-first</p>
                    </div>
                </div>

                <div id="loginPanel">
                    <div style="display:flex; gap:10px; width:100%">
                        <button id="loginBtn" class="primary" style="font-size:14px; padding:8px;">ä½¿ç”¨ Google ç™»å…¥</button>
                        <button id="logoutBtn" class="danger hidden" style="font-size:14px; padding:8px;">ç™»å‡º</button>
                    </div>
                    <span id="userInfo"></span>
                </div>

                <div id="keyWrapper" class="hidden" style="margin-top:10px; width:100%;">
                    <button id="toggleKeyBtn"
                        style="width:100%; background:#1f2937; color:#fff; font-size:12px; padding:8px;">â–¼ è¨­å®š GPT API
                        Key</button>
                    <div id="keySection"
                        style="display:none; margin-top:10px; padding:10px; background:#111827; border-radius:10px;">
                        <input id="gptKey" type="password" placeholder="è¼¸å…¥ OpenAI API Key (sk-...)"
                            style="margin-bottom:8px;">
                        <button id="saveKeyBtn" class="primary" style="width:100%">å„²å­˜ Key</button>
                        <p id="status" style="font-size:12px; margin:5px 0 0 0; color:#aaa;"></p>
                    </div>
                </div>
            </header>

            <div class="section">
                <div class="row-fields">
                    <div class="sub-field">
                        <label class="label" for="lang">é¸æ“‡èªè¨€</label>
                        <select id="lang">
                            <option value="en-US">English ğŸ‡ºğŸ‡¸</option>
                            <option value="it-IT">Italiano ğŸ‡®ğŸ‡¹</option>
                            <option value="zh-TW">ä¸­æ–‡ (ç¹é«”) ğŸ‡¹ğŸ‡¼</option>
                            <option value="ja-JP">æ—¥æœ¬èª ğŸ‡¯ğŸ‡µ</option>
                            <option value="fr-FR">FranÃ§ais ğŸ‡«ğŸ‡·</option>
                            <option value="de-DE">Deutsch ğŸ‡©ğŸ‡ª</option>
                            <option value="es-ES">EspaÃ±ol ğŸ‡ªğŸ‡¸</option>
                            <option value="pt-PT">PortuguÃªs ğŸ‡µğŸ‡¹</option>
                            <option value="ru-RU">Ğ ÑƒÑÑĞºĞ¸Ğ¹ ğŸ‡·ğŸ‡º</option>
                            <option value="hi-IN">à¤¹à¤¿à¤¨à¥à¤¦à¥€ / Ø§ÙØ±Ø¯ÙÙˆ ğŸ‡®ğŸ‡³</option>
                            <option value="bn-BD">à¦¬à¦¾à¦‚à¦²à¦¾ ğŸ‡§ğŸ‡©</option>
                            <option value="fa-IR">ÙØ§Ø±Ø³ÛŒ ğŸ‡®ğŸ‡·</option>
                            <option value="ta-IN">à®¤à®®à®¿à®´à¯ ğŸ‡®ğŸ‡³</option>
                            <option value="ar-SA">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ğŸ‡¸ğŸ‡¦</option>
                            <option value="tr-TR">TÃ¼rkÃ§e ğŸ‡¹ğŸ‡·</option>
                            <option value="ko-KR">í•œêµ­ì–´ ğŸ‡°ğŸ‡·</option>
                            <option value="vi-VN">Tiáº¿ng Viá»‡t ğŸ‡»ğŸ‡³</option>
                            <option value="id-ID">Bahasa Indonesia / Melayu ğŸ‡®ğŸ‡©</option>
                            <option value="th-TH">à¹„à¸—à¸¢ ğŸ‡¹ğŸ‡­</option>
                            <option value="sw-KE">Kiswahili ğŸ‡°ğŸ‡ª</option>
                        </select>
                    </div>
                    <div class="sub-field">
                        <label class="label" for="voice">èªéŸ³é¸æ“‡</label>
                        <select id="voice"></select>
                    </div>
                </div>

                <div class="field">
                    <label class="label">è¼¸å…¥è¦ç·´ç¿’çš„å…§å®¹</label>
                    <textarea id="text" placeholder="ä¾‹å¦‚ï¼šCiao! Come stai?"></textarea>
                    <div class="chips" id="samples"></div>
                </div>

                <div class="row-fields">
                    <div class="sub-field">
                        <label class="label">èªé€Ÿ <span id="rateVal">1.0</span></label>
                        <input type="range" id="rate" min="0.6" max="1.6" step="0.1" value="1.0">
                    </div>
                    <div class="sub-field">
                        <label class="label">éŸ³é«˜ <span id="pitchVal">1.0</span></label>
                        <input type="range" id="pitch" min="0.6" max="1.4" step="0.1" value="1.0">
                    </div>
                </div>

                <div class="field">
                    <label class="label">å­—é«”å¤§å° <span id="fontSizeVal">72</span> px</label>
                    <input type="range" id="fontSize" min="16" max="240" step="1" value="72">
                </div>

                <div id="ipaWrap" style="display:none; text-align:center; margin-top:8px;">
                    <img id="ipaImg" src="" alt=""
                        style="max-width:100%; max-height:120px; display:none; margin: 0 auto 6px auto;">
                    <div id="ipa"></div>
                </div>

                <div class="field">
                    <label class="label">æ‰‹å¯«ç·´ç¿’å€</label>
                    <canvas id="pad"></canvas>
                    <div class="pad-actions">
                        <button class="danger" id="clearBtn">ğŸ§¹ æ¸…é™¤ç•«å¸ƒ</button>
                        <button class="primary" id="speakBtn">â–¶ é–‹å§‹æœ—è®€</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <script>
        // --- Firebase åˆå§‹åŒ– ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqZLFskqgyiAEc127dh95rXsOPQVLSurM",
            authDomain: "test-5dbba.firebaseapp.com",
            projectId: "test-5dbba",
            storageBucket: "test-5dbba.appspot.com",
            messagingSenderId: "878665537417",
            appId: "1:878665537417:web:xxxxxx"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        // åœ¨ test1.html çš„ <script> ä¸­åŠ å…¥æ­¤è®€å–é‚è¼¯
        const sharedLang = localStorage.getItem('userLang') || 'en-US';
        const sharedCourse = localStorage.getItem('userCourse') || 'all';
        const sharedKey = localStorage.getItem('gptApiKey') || '';

        // === Google TTS ä¸»è¦å£éŸ³åˆ†çµ„è¨­å®š ===
        const VOICE_VARIANTS = {
            "zh-TW": { include: ["cmn-TW", "cmn-CN", "zh-TW", "zh-CN"], labels: { "cmn-TW": "å°ç£", "cmn-CN": "ä¸­åœ‹", "zh-TW": "å°ç£", "zh-CN": "ä¸­åœ‹" } },
            "en-US": { include: ["en-US", "en-GB", "en-AU", "en-CA"], labels: { "en-US": "ç¾å¼", "en-GB": "è‹±å¼", "en-AU": "æ¾³æ´²", "en-CA": "åŠ æ‹¿å¤§" } },
            "de-DE": { include: ["de-DE", "de-AT", "de-CH"], labels: { "de-DE": "å¾·åœ‹", "de-AT": "å¥§åœ°åˆ©", "de-CH": "ç‘å£«" } },
            "es-ES": { include: ["es-ES", "es-MX", "es-US", "es-AR"], labels: { "es-ES": "è¥¿ç­ç‰™", "es-MX": "å¢¨è¥¿å“¥", "es-US": "ç¾åœ‹", "es-AR": "é˜¿æ ¹å»·" } },
            "pt-PT": { include: ["pt-PT", "pt-BR"], labels: { "pt-PT": "æ­æ´²", "pt-BR": "å·´è¥¿" } },
            "fr-FR": { include: ["fr-FR", "fr-CA"], labels: { "fr-FR": "æ³•åœ‹", "fr-CA": "åŠ æ‹¿å¤§" } },
            "it-IT": { include: ["it-IT"], labels: { "it-IT": "ç¾©å¤§åˆ©" } },
            "ru-RU": { include: ["ru-RU"], labels: { "ru-RU": "ä¿„ç¾…æ–¯" } },
            "hi-IN": { include: ["hi-IN", "ur-PK"], labels: { "hi-IN": "å°åœ°èª", "ur-PK": "çƒçˆ¾éƒ½èª" } },
            "bn-BD": { include: ["bn-BD", "bn-IN"], labels: { "bn-BD": "å­ŸåŠ æ‹‰", "bn-IN": "å°åº¦å­ŸåŠ æ‹‰" } },
            "fa-IR": { include: ["fa-IR", "fa-AF"], labels: { "fa-IR": "ä¼Šæœ—", "fa-AF": "é˜¿å¯Œæ±—" } },
            "ta-IN": { include: ["ta-IN", "ta-LK"], labels: { "ta-IN": "å°åº¦", "ta-LK": "æ–¯é‡Œè˜­å¡" } },
            "ar-SA": { include: ["ar-SA", "ar-EG", "ar-XA"], labels: { "ar-SA": "æ²™çƒåœ°", "ar-EG": "åŸƒåŠ", "ar-XA": "æ±é˜¿æ‹‰ä¼¯" } },
            "tr-TR": { include: ["tr-TR"], labels: { "tr-TR": "åœŸè€³å…¶" } },
            "ja-JP": { include: ["ja-JP"], labels: { "ja-JP": "æ—¥æœ¬" } },
            "ko-KR": { include: ["ko-KR"], labels: { "ko-KR": "éŸ“åœ‹" } },
            "vi-VN": { include: ["vi-VN"], labels: { "vi-VN": "è¶Šå—ï¼ˆåŒ—éƒ¨ï¼‰" } },
            "id-ID": { include: ["id-ID", "ms-MY"], labels: { "id-ID": "å°å°¼èª", "ms-MY": "é¦¬ä¾†èª" } },
            "th-TH": { include: ["th-TH"], labels: { "th-TH": "æ³°åœ‹" } },
            "sw-KE": { include: ["sw-KE", "sw-TZ"], labels: { "sw-KE": "è‚¯äº", "sw-TZ": "å¦å°šå°¼äº" } }
        };

        // --- UI å…ƒç´  ---
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfo = document.getElementById('userInfo');
        const keyWrapper = document.getElementById('keyWrapper');
        const keySection = document.getElementById('keySection');
        const toggleKeyBtn = document.getElementById('toggleKeyBtn');
        const gptKeyInput = document.getElementById('gptKey');
        const saveKeyBtn = document.getElementById('saveKeyBtn');
        const statusEl = document.getElementById('status');

        const langEl = document.getElementById('lang');
        const voiceEl = document.getElementById('voice');
        const textEl = document.getElementById('text');
        const rateEl = document.getElementById('rate');
        const pitchEl = document.getElementById('pitch');
        const rateVal = document.getElementById('rateVal');
        const pitchVal = document.getElementById('pitchVal');
        const fontSizeEl = document.getElementById('fontSize');
        const fontSizeVal = document.getElementById('fontSizeVal');
        const ipaWrap = document.getElementById('ipaWrap');
        const ipaEl = document.getElementById('ipa');
        const ipaImg = document.getElementById('ipaImg');
        const canvas = document.getElementById('pad');
        const ctx = canvas.getContext('2d');
        const samplesEl = document.getElementById('samples');

        let lastIPAQuery = { text: '', lang: '', ipa: '' };

        // === ç™»å…¥ / ç™»å‡º ===
        loginBtn.onclick = () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .catch(err => alert("ç™»å…¥å¤±æ•—ï¼š" + err.message));
        };
        logoutBtn.onclick = () => auth.signOut();

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                userInfo.textContent = `å·²ç™»å…¥ï¼š${user.email}`;
                keyWrapper.classList.remove('hidden');

                // è®€å– Firestore ä½¿ç”¨è€…çš„ Key
                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    const savedKey = doc.exists ? doc.data().gptApiKey : null;
                    if (savedKey) {
                        gptKeyInput.value = savedKey;
                        statusEl.textContent = "âœ… å·²è¼‰å…¥ Firestore ä¸­çš„ Key";
                    } else {
                        statusEl.textContent = "âš ï¸ å°šæœªå„²å­˜ API Key";
                    }
                } catch (e) {
                    statusEl.textContent = "âŒ è®€å–å¤±æ•—ï¼š" + e.message;
                }
            } else {
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                userInfo.textContent = '';
                keyWrapper.classList.add('hidden');
                gptKeyInput.value = '';
            }
        });

        // Toggle Key Section
        toggleKeyBtn.addEventListener('click', () => {
            const isHidden = keySection.style.display === 'none';
            keySection.style.display = isHidden ? 'block' : 'none';
            toggleKeyBtn.textContent = isHidden ? 'â–² éš±è— GPT è¨­å®š' : 'â–¼ è¨­å®š GPT API Key';
        });

        // Save Key
        saveKeyBtn.onclick = async () => {
            if (!auth.currentUser) return alert("è«‹å…ˆç™»å…¥ï¼");
            const key = gptKeyInput.value.trim();
            if (!key) return alert("è«‹è¼¸å…¥ API Key");
            try {
                await db.collection('users').doc(auth.currentUser.uid).set({
                    gptApiKey: key,
                    gptUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                statusEl.textContent = "âœ… å·²å„²å­˜åˆ° Firestoreï¼";
            } catch (err) {
                statusEl.textContent = "âŒ å„²å­˜å¤±æ•—ï¼š" + err.message;
            }
        };


        // === Canvas & TTS ===
        const DPR = window.devicePixelRatio || 1;
        let strokes = []; let isDrawing = false; let currentStroke = null;
        let customFontSize = 72;

        async function loadSwadeshCSV() {
            try {
                const resp = await fetch('swadesh.csv');
                if (!resp.ok) throw new Error("CSV not found");
                const csvText = await resp.text();
                const data = Papa.parse(csvText, { header: true }).data;
                const SAMPLE_TEXTS = {};

                data.forEach(row => {
                    for (const [lang, word] of Object.entries(row)) {
                        if (!word) continue;
                        if (!SAMPLE_TEXTS[lang]) SAMPLE_TEXTS[lang] = [];
                        SAMPLE_TEXTS[lang].push(word);
                    }
                });

                window.SAMPLE_TEXTS = SAMPLE_TEXTS;
                renderChips();
            } catch (e) {
                console.log("No Swadesh CSV found or parsing error, skipping.");
                window.SAMPLE_TEXTS = {};
            }
        }

        loadSwadeshCSV();

        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * DPR; canvas.height = rect.height * DPR;
            ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
            ctx.lineWidth = 2; ctx.lineJoin = 'round'; ctx.lineCap = 'round'; ctx.strokeStyle = '#22d3ee';
            redraw();
        }
        window.addEventListener('resize', resizeCanvas);

        function wrapTextSmart(text, maxW, fontSize) {
            ctx.font = `${fontSize}px sans-serif`;
            const useWords = /\s/.test(text);
            const units = useWords ? text.split(/\s+/) : [...text];
            const lines = []; let line = '';
            for (const u of units) {
                const test = line ? (useWords ? line + ' ' + u : line + u) : u;
                if (ctx.measureText(test).width > maxW * 0.92 && line) { lines.push(line); line = u; }
                else line = test;
            }
            if (line) lines.push(line);
            return lines.slice(0, 6);
        }

        function drawBackgroundText() {
            const text = textEl.value.trim();
            ctx.save(); ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = 'rgba(200,200,200,0.25)';
            const maxW = canvas.width / DPR, maxH = canvas.height / DPR;
            if (text) {
                const fs = customFontSize;
                const lines = wrapTextSmart(text, maxW, fs);
                ctx.font = `${fs}px sans-serif`; const lh = fs * 1.2;
                const startY = (maxH / 2) - ((lines.length - 1) * lh / 2);
                lines.forEach((line, i) => ctx.fillText(line, maxW / 2, startY + i * lh));
            } else { ctx.font = '20px sans-serif'; ctx.fillText('åœ¨æ­¤æ‰‹å¯«â€¦', maxW / 2, maxH / 2); }
            ctx.restore();
        }

        function drawStrokes() {
            ctx.save(); ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 4; ctx.lineJoin = 'round'; ctx.lineCap = 'round';
            const draw = s => {
                if (!s || s.length < 2) return; ctx.beginPath(); ctx.moveTo(s[0].x, s[0].y);
                for (let i = 1; i < s.length; i++)ctx.lineTo(s[i].x, s[i].y); ctx.stroke();
            };
            strokes.forEach(draw); if (currentStroke) draw(currentStroke); ctx.restore();
        }

        function redraw() { ctx.clearRect(0, 0, canvas.width, canvas.height); drawBackgroundText(); drawStrokes(); }

        function posFromEvent(e) { const r = canvas.getBoundingClientRect(); return { x: e.clientX - r.left, y: e.clientY - r.top }; }
        canvas.addEventListener('pointerdown', e => { canvas.setPointerCapture(e.pointerId); isDrawing = true; currentStroke = [posFromEvent(e)]; redraw(); });
        canvas.addEventListener('pointermove', e => { if (!isDrawing) return; currentStroke.push(posFromEvent(e)); redraw(); });
        function endStroke() { if (isDrawing && currentStroke?.length) { strokes.push(currentStroke); currentStroke = null; redraw(); } isDrawing = false; }
        canvas.addEventListener('pointerup', endStroke);
        canvas.addEventListener('pointercancel', endStroke);
        canvas.addEventListener('pointerleave', endStroke);
        document.getElementById('clearBtn').addEventListener('click', () => { strokes = []; redraw(); });

        // TTS Voices
        function loadVoices() {
            let voices = speechSynthesis.getVoices();
            if (!voices.length) return;

            const lang = langEl.value;
            voiceEl.innerHTML = '';

            const variant = VOICE_VARIANTS[lang];
            let list = [];

            if (variant) {
                list = voices.filter(v =>
                    variant.include.some(code => v.lang?.toLowerCase().replace('_', '-').startsWith(code.toLowerCase()))
                );
            }
            if (!list.length) {
                list = voices.filter(v => v.lang?.toLowerCase().replace('_', '-').startsWith(lang.toLowerCase().split('-')[0]));
            }

            // Fallback: å¦‚æœéƒ½æ²’æ‰¾åˆ°ï¼Œé¡¯ç¤ºæ‰€æœ‰
            const finalVoices = list.length ? list : voices;

            finalVoices.forEach(v => {
                const opt = document.createElement('option');
                const label = variant?.labels?.[v.lang] || v.lang;
                opt.value = v.name;
                opt.textContent = `${v.name} (${label})`;
                voiceEl.appendChild(opt);
            });
        }

        function waitForVoices() {
            return new Promise(resolve => {
                let id = setInterval(() => {
                    if (speechSynthesis.getVoices().length) {
                        clearInterval(id);
                        resolve();
                    }
                }, 250);
            });
        }

        speechSynthesis.onvoiceschanged = loadVoices;
        waitForVoices().then(loadVoices);

        voiceEl.addEventListener('change', () => {
            if (textEl.value.trim()) {
                // ä¸è‡ªå‹•æœ—è®€ï¼Œé¿å…å¤ªåµï¼Œåªæ›´æ–° voice
            }
        });

        langEl.addEventListener('change', () => {
            loadVoices();
            if (window.SAMPLE_TEXTS && window.SAMPLE_TEXTS[langEl.value]) {
                textEl.placeholder = window.SAMPLE_TEXTS[langEl.value][0];
            } else {
                textEl.placeholder = "è¼¸å…¥æ–‡å­—...";
            }
            renderChips();
        });

        // Speak & Fetch IPA
        async function speakNow() {
            const text = textEl.value.trim();
            if (!text) return;

            // TTS
            const u = new SpeechSynthesisUtterance(text);
            const voices = speechSynthesis.getVoices();
            const sel = voices.find(v => v.name === voiceEl.value);
            if (sel) u.voice = sel;
            u.lang = langEl.value;
            u.rate = parseFloat(rateEl.value);
            u.pitch = parseFloat(pitchEl.value);
            speechSynthesis.cancel();
            speechSynthesis.speak(u);

            // Fetch IPA
            if (lastIPAQuery.text !== text || lastIPAQuery.lang !== langEl.value) {
                await fetchIPA(text, langEl.value);
            } else {
                ipaWrap.style.display = 'block';
                ipaEl.textContent = `ğŸ“˜ IPA: ${lastIPAQuery.ipa}`;
            }
        }

        // ä¿®æ”¹å¾Œçš„ fetchIPA å‡½æ•¸ï¼ŒåŠ å…¥å¿«å–æ©Ÿåˆ¶
        async function fetchIPA(text, langCode) {
            const sentence = text.trim();
            if (!sentence) return;

            ipaWrap.style.display = 'block';
            ipaEl.textContent = 'ğŸ”„ æŸ¥è©¢ä¸­...';

            // ç”¢ç”Ÿå­˜æ”¾æ–¼è³‡æ–™åº«çš„å”¯ä¸€ ID (èªè¨€+æ–‡å­—)
            const cacheId = `${langCode}_${sentence}`.replace(/[\/\.#$\[\]]/g, '_');

            try {
                // --- æ­¥é©Ÿ 1: æª¢æŸ¥ Firestore å¿«å– ---
                const cacheDoc = await db.collection('ipa_cache').doc(cacheId).get();
                if (cacheDoc.exists) {
                    const cachedIpa = cacheDoc.data().ipa;
                    ipaEl.textContent = `ğŸ“˜ IPA (å¿«å–): ${cachedIpa}`;
                    lastIPAQuery = { text: sentence, lang: langCode, ipa: cachedIpa };
                    showWordImage(sentence);
                    return; // æ‰¾åˆ°å¿«å–ï¼Œç›´æ¥çµæŸï¼Œä¸å‘¼å« GPT
                }

                // --- æ­¥é©Ÿ 2: å¦‚æœæ²’æœ‰å¿«å–ï¼Œå‰‡å‘¼å« GPT ---
                const gptKey = gptKeyInput.value.trim();
                if (!gptKey) {
                    ipaEl.textContent = 'âš ï¸ è«‹è¨­å®š GPT Key ä»¥å–å¾— IPA';
                    return;
                }

                const langName = langEl.options[langEl.selectedIndex].textContent.replace(/ ?[^\w\s\(\)]/g, '').trim();
                const prompt = `Please write the full International Phonetic Alphabet (IPA) transcription for the following sentence in ${langName}: "${sentence}". Only output the IPA transcription, no explanations.`;

                const resp = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${gptKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0
                    })
                });

                const data = await resp.json();
                if (resp.ok && data.choices?.[0]?.message?.content) {
                    const ipa = data.choices[0].message.content.trim();

                    // --- æ­¥é©Ÿ 3: å°‡çµæœå­˜å…¥ Firestore å¿«å– ---
                    await db.collection('ipa_cache').doc(cacheId).set({
                        text: sentence,
                        lang: langCode,
                        ipa: ipa,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    ipaEl.textContent = `ğŸ“˜ IPA: ${ipa}`;
                    lastIPAQuery = { text: sentence, lang: langCode, ipa };
                } else {
                    throw new Error(data.error?.message || "GPT æŸ¥è©¢å¤±æ•—");
                }

            } catch (e) {
                console.error("IPA è™•ç†éŒ¯èª¤", e);
                ipaEl.textContent = `âŒ éŒ¯èª¤: ${e.message}`;
            }

            showWordImage(sentence);
        }
        function showWordImage(word) {
            // æ³¨æ„ï¼šé€™è£¡å‡è¨­ swadesh è³‡æ–™å¤¾å­˜åœ¨ï¼Œè‹¥æ²’æœ‰å‰‡æœƒéš±è—åœ–ç‰‡
            const base = `swadesh/${encodeURIComponent(word)}`;
            ipaImg.style.display = 'none';

            // ç°¡å–®çš„åœ–ç‰‡è¼‰å…¥å˜—è©¦
            const tryImg = new Image();
            tryImg.onload = () => {
                ipaImg.src = tryImg.src;
                ipaImg.style.display = 'block';
            };
            tryImg.onerror = () => {
                // è©¦è©¦ png
                const tryPng = new Image();
                tryPng.onload = () => {
                    ipaImg.src = tryPng.src;
                    ipaImg.style.display = 'block';
                };
                tryPng.src = `${base}.png`;
            };
            tryImg.src = `${base}.jpg`;
        }

        // Listeners
        rateEl.addEventListener('input', () => { rateVal.textContent = rateEl.value; });
        pitchEl.addEventListener('input', () => { pitchVal.textContent = pitchEl.value; });
        fontSizeEl.addEventListener('input', () => {
            customFontSize = parseInt(fontSizeEl.value, 10);
            fontSizeVal.textContent = customFontSize; redraw();
        });
        textEl.addEventListener('input', () => redraw());
        document.getElementById('speakBtn').addEventListener('click', speakNow);

        function renderChips() {
            if (!window.SAMPLE_TEXTS) return;
            const allWords = window.SAMPLE_TEXTS[sharedLang] || [];
            samplesEl.innerHTML = '';

            let [start, end] = sharedCourse === 'all' ? [1, 207] : sharedCourse.split('-').map(Number);

            allWords.forEach((txt, i) => {
                const num = i + 1;
                if (num >= start && num <= end) {
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.textContent = txt;
                    chip.onclick = () => {
                        textEl.value = txt;
                        redraw();
                        speakNow(); // æœƒè‡ªå‹•èª¿ç”¨ sharedKey
                    };
                    samplesEl.appendChild(chip);
                }
            });
        }

        // Init
        renderChips();
        resizeCanvas();
    </script>
</body>

</html>