<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Climbing Toolbox - æŒ‡åŠ›è¨“ç·´</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- æ‹–æ›³å¥—ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <!-- å…±ç”¨è¨­å®š -->
    <script src="config.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* è¦–åœ–åˆ‡æ› */
        .view-section {
            display: none;
            height: 100%;
            overflow-y: auto;
            padding-bottom: 80px;
        }

        .view-section.active {
            display: block;
        }

        /* æ¨¡æ…‹è¦–çª—éæ¸¡ */
        .modal {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            transform: translateY(100%);
        }

        .modal.open {
            transform: translateY(0);
        }

        /* éš±è—æ²è»¸ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* ç©æœ¨æ¨£å¼åŸºç¤ */
        .block-item {
            touch-action: none;
            transition: transform 0.1s;
        }

        .block-item:active {
            transform: scale(0.98);
        }

        .sortable-ghost {
            opacity: 0.4;
            background: #e5e7eb;
            border: 1px dashed #9ca3af;
        }

        .sortable-drag {
            opacity: 0.9;
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* å·¢ç‹€ç¸®æ’ç·šæ¢ */
        .nested-container {
            min-height: 50px;
            margin-top: 0.5rem;
            border-radius: 0.5rem;
            background-color: rgba(0, 0, 0, 0.03);
            border: 1px dashed #cbd5e1;
        }

        /* å±¬æ€§é¢æ¿ */
        #prop-sheet {
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }

        /* é¡è‰²é¸æ“‡å™¨æ¨£å¼ */
        .color-btn {
            transition: all 0.2s;
        }

        .color-btn.selected {
            transform: scale(1.1);
            ring-width: 2px;
            --tw-ring-offset-width: 2px;
            --tw-ring-color: #3b82f6;
            /* blue-500 */
            box-shadow: 0 0 0 2px white, 0 0 0 4px currentColor;
        }

        /* èªéŸ³ç‹€æ…‹å‹•ç•« */
        .mic-listening {
            animation: pulse-red 1.5s infinite;
            background-color: #ef4444 !important;
            color: white !important;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Toggle Switch Style */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #3b82f6;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 h-[100dvh] w-full overflow-hidden flex flex-col">

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main id="app-container" class="flex-1 relative overflow-hidden w-full max-w-md mx-auto bg-white shadow-2xl">

        <!-- 1. æ—¥æ›†èˆ‡ç´€éŒ„ (Calendar) -->
        <div id="view-calendar" class="view-section active">
            <div class="p-6">
                <div class="flex items-center mb-6">
                    <a href="index.html" class="p-1.5 text-gray-500 hover:text-blue-600 transition-colors mr-2"
                        title="Home">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                            </path>
                        </svg>
                    </a>
                    <h1 class="text-2xl font-extrabold">è¨“ç·´ç´€éŒ„</h1>
                </div>

                <div class="bg-gray-900 text-white rounded-2xl p-6 mb-8 shadow-lg">
                    <div class="text-sm text-gray-400 mb-1">æœ¬é€±è¨“ç·´</div>
                    <div class="text-4xl font-mono font-bold mb-4">3 <span
                            class="text-lg font-normal text-gray-500">æ¬¡</span></div>
                    <div class="flex gap-4 text-sm border-t border-gray-700 pt-4">
                        <div>
                            <div class="text-gray-400">ç¸½æ™‚é•·</div>
                            <div class="font-bold">45m</div>
                        </div>
                        <div>
                            <div class="text-gray-400">æœ€å¤§è² é‡</div>
                            <div class="font-bold text-yellow-500">+20kg</div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-2 mb-4 text-center text-sm text-gray-400">
                    <div>M</div>
                    <div>T</div>
                    <div>W</div>
                    <div>T</div>
                    <div>F</div>
                    <div>S</div>
                    <div>S</div>
                </div>
                <div class="grid grid-cols-7 gap-2" id="calendar-grid"></div>
            </div>
        </div>

        <!-- 2. èª²è¡¨ç®¡ç† (Routines) -->
        <div id="view-routines" class="view-section">
            <div
                class="p-6 sticky top-0 bg-white/95 backdrop-blur z-10 border-b border-gray-100 flex justify-between items-center">
                <div class="flex items-center">
                    <a href="index.html" class="p-1.5 text-gray-500 hover:text-blue-600 transition-colors mr-2"
                        title="Home">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                            </path>
                        </svg>
                    </a>
                    <h1 class="text-2xl font-extrabold">æˆ‘çš„èª²è¡¨</h1>
                </div>
                <button onclick="editor.open()"
                    class="bg-gray-900 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:scale-105 transition-transform">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </button>
            </div>
            <div id="routine-list" class="p-4 space-y-3 pb-24">
                <div class="text-center text-gray-400 mt-10">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <!-- 3. è¨­å®š (Settings) -->
        <div id="view-settings" class="view-section">
            <div class="p-6">
                <div class="flex items-center mb-6">
                    <a href="index.html" class="p-1.5 text-gray-500 hover:text-blue-600 transition-colors mr-2"
                        title="Home">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                            </path>
                        </svg>
                    </a>
                    <h1 class="text-2xl font-extrabold">è¨­å®š</h1>
                </div>

                <div class="space-y-6 pb-12">
                    <!-- Auth Section -->
                    <div class="bg-white border rounded-xl p-4 flex items-center gap-4">
                        <div class="w-12 h-12 bg-gray-200 rounded-full flex-shrink-0 overflow-hidden">
                            <img id="avatar-img" class="w-full h-full object-cover hidden">
                            <div id="avatar-placeholder"
                                class="w-full h-full flex items-center justify-center text-gray-400">ğŸ‘¤</div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div id="settings-email" class="font-bold truncate">æœªç™»å…¥</div>
                            <div class="text-xs text-gray-500">åŒæ­¥æ‚¨çš„è¨“ç·´æ•¸æ“š</div>
                        </div>
                        <button id="auth-btn" class="text-sm text-blue-600 font-bold whitespace-nowrap">ç™»å…¥</button>
                    </div>

                    <!-- Sound & Audio Section -->
                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">éŸ³æ•ˆèˆ‡èªéŸ³</h3>
                        <div class="bg-white border rounded-xl overflow-hidden">
                            <!-- Master Sound Switch -->
                            <div class="p-4 flex justify-between items-center border-b border-gray-100">
                                <span class="font-medium">å•Ÿç”¨éŸ³æ•ˆ</span>
                                <div
                                    class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="set-sound-enabled"
                                        class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300" />
                                    <label for="set-sound-enabled"
                                        class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>

                            <!-- TTS Switch -->
                            <div class="p-4 flex justify-between items-center border-b border-gray-100">
                                <span class="font-medium">æœ—è®€é …ç›® (TTS)</span>
                                <div
                                    class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="set-tts-enabled"
                                        class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300" />
                                    <label for="set-tts-enabled"
                                        class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>

                            <!-- Countdown Trigger (Seconds Input) -->
                            <div class="p-4 flex justify-between items-center border-b border-gray-100">
                                <span class="font-medium">å€’æ•¸æç¤ºæ™‚æ©Ÿ</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-500">æœ€å¾Œ</span>
                                    <input type="number" id="set-countdown-sec"
                                        class="w-16 border border-gray-300 rounded-lg p-1 text-center font-mono font-bold"
                                        value="3" min="0" max="60">
                                    <span class="text-sm text-gray-500">ç§’</span>
                                </div>
                            </div>

                            <!-- Speech Rate -->
                            <div class="p-4">
                                <div class="flex justify-between mb-2">
                                    <span class="font-medium">èªéŸ³èªé€Ÿ</span>
                                    <span id="lbl-speech-rate" class="text-sm font-bold text-blue-600">1.0x</span>
                                </div>
                                <input type="range" id="set-speech-rate" min="0.5" max="2" step="0.1"
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                <div class="flex justify-between text-xs text-gray-400 mt-1">
                                    <span>æ…¢</span>
                                    <span>å¿«</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Device Section -->
                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">è£ç½®é€£ç·š</h3>
                        <div class="bg-white border rounded-xl overflow-hidden">
                            <button class="w-full p-4 flex justify-between items-center hover:bg-gray-50 border-b">
                                <span class="font-medium">é€£æ¥è—èŠ½åŠç§¤</span>
                                <span class="text-gray-400 text-sm">æœªé€£ç·š</span>
                            </button>
                            <button class="w-full p-4 flex justify-between items-center hover:bg-gray-50">
                                <span class="font-medium">æ„Ÿæ¸¬å™¨æ­¸é›¶</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- åº•éƒ¨å°è¦½åˆ— (ä¿®æ­£ç‰ˆ) -->
    <nav
        class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 h-16 w-full max-w-md mx-auto z-50 flex justify-around items-center shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        <button onclick="router.go('calendar')"
            class="nav-btn w-full h-full flex flex-col items-center justify-center text-gray-400 hover:text-gray-900 active"
            data-target="view-calendar">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <span class="text-[10px] font-bold">ç´€éŒ„</span>
        </button>
        <button onclick="router.go('routines')"
            class="nav-btn w-full h-full flex flex-col items-center justify-center text-gray-400 hover:text-gray-900"
            data-target="view-routines">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                </path>
            </svg>
            <span class="text-[10px] font-bold">èª²è¡¨</span>
        </button>
        <button onclick="router.go('settings')"
            class="nav-btn w-full h-full flex flex-col items-center justify-center text-gray-400 hover:text-gray-900"
            data-target="view-settings">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                </path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <span class="text-[10px] font-bold">è¨­å®š</span>
        </button>
    </nav>

    <!-- æ¨¡æ…‹è¦–çª—: ç·¨è¼¯å™¨ (Editor Modal) -->
    <div id="modal-editor" class="modal fixed inset-0 z-50 bg-gray-100 flex flex-col">
        <div class="bg-white px-4 py-3 border-b flex items-center justify-between shrink-0">
            <button onclick="editor.close()" class="text-gray-500 font-bold px-2">å–æ¶ˆ</button>
            <input type="text" id="editor-title"
                class="text-center font-bold text-lg bg-transparent border-none focus:ring-0 w-48" placeholder="è¼¸å…¥èª²è¡¨åç¨±">
            <button onclick="editor.save()" class="text-blue-600 font-bold px-2">å„²å­˜</button>
        </div>

        <!-- èª²è¡¨è¨­å®šåˆ— -->
        <div class="px-4 py-2 bg-gray-50 border-b flex items-center justify-between text-xs text-gray-500 shrink-0">
            <label class="flex items-center gap-2 cursor-pointer select-none">
                <input type="checkbox" id="editor-skip-rest"
                    class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                <span class="font-medium">è·³éæœ€å¾Œä¼‘æ¯</span>
            </label>
        </div>

        <div class="flex-1 overflow-y-auto p-4 pb-32" id="editor-canvas">
            <!-- ç©æœ¨å°‡åœ¨æ­¤ç”Ÿæˆ -->
            <div class="text-center text-gray-400 mt-20 text-sm pointer-events-none">å¾ä¸‹æ–¹æ‹–æ›³ç©æœ¨è‡³æ­¤</div>
        </div>

        <!-- åº•éƒ¨å·¥å…·ç®± -->
        <div class="bg-white border-t p-4 shrink-0 shadow-xl z-10 pb-8">
            <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">æ‹–æ›³æ–°å¢</div>
            <div id="editor-palette" class="flex gap-3 overflow-x-auto no-scrollbar">
                <div class="palette-item shrink-0 w-20 h-16 bg-violet-50 border-2 border-violet-200 rounded-lg flex flex-col items-center justify-center cursor-grab"
                    data-type="loop">
                    <span class="text-xs font-bold text-violet-700">å¾ªç’° Loop</span>
                </div>
                <div class="palette-item shrink-0 w-20 h-16 bg-orange-50 border-2 border-orange-200 rounded-lg flex flex-col items-center justify-center cursor-grab"
                    data-type="timer">
                    <span class="text-xs font-bold text-orange-700">è¨ˆæ™‚ Timer</span>
                </div>
                <div class="palette-item shrink-0 w-20 h-16 bg-blue-50 border-2 border-blue-200 rounded-lg flex flex-col items-center justify-center cursor-grab"
                    data-type="reps">
                    <span class="text-xs font-bold text-blue-700">è¨ˆæ•¸ Reps</span>
                </div>
            </div>
        </div>

        <!-- å±¬æ€§ç·¨è¼¯é¢æ¿ (Property Sheet) -->
        <div id="prop-sheet"
            class="absolute bottom-0 inset-x-0 bg-white rounded-t-2xl transform translate-y-full transition-transform duration-300 z-[60] p-6 pb-12">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">ç·¨è¼¯ç©æœ¨</h3>
                <button onclick="editor.closeProps()" class="p-2 bg-gray-100 rounded-full">âœ•</button>
            </div>

            <div id="prop-form" class="space-y-4">
                <!-- JS å‹•æ…‹ç”Ÿæˆ -->
            </div>

            <!-- é¡è‰²é¸æ“‡å™¨ (é ç•™ä½ç½®) -->
            <div class="mt-4">
                <label class="block text-sm font-bold text-gray-500 mb-2">é¡è‰²æ¨™è¨˜</label>
                <div id="color-palette" class="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                    <!-- JS ç”Ÿæˆè‰²ç¥¨ -->
                </div>
            </div>

            <div class="mt-6 flex gap-3">
                <button onclick="editor.deleteCurrentBlock()"
                    class="flex-1 py-3 bg-red-50 text-red-600 rounded-xl font-bold border border-red-100">åˆªé™¤</button>
                <button onclick="editor.saveProps()"
                    class="flex-1 py-3 bg-gray-900 text-white rounded-xl font-bold">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ…‹è¦–çª—: å…¨è¢å¹•è¨ˆæ™‚å™¨ (Active Timer Modal) -->
    <div id="modal-active-timer" class="modal fixed inset-0 z-[60] bg-gray-900 text-white flex flex-col">
        <!-- é ‚éƒ¨è³‡è¨Š -->
        <div class="p-6 flex justify-between items-start shrink-0">
            <div class="flex items-start gap-3">
                <!-- èªéŸ³æ§åˆ¶æŒ‰éˆ• -->
                <button id="btn-mic-toggle" onclick="voiceCommander.toggle()"
                    class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-all text-white/50">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z">
                        </path>
                    </svg>
                </button>
                <div>
                    <h3 id="active-title" class="font-bold text-lg opacity-90 leading-tight">Routine Name</h3>
                    <div class="text-xs text-gray-400 font-mono mt-1" id="active-total-time">Total: 00:00</div>
                </div>
            </div>
            <button onclick="timer.stop()" class="p-2 bg-white/10 rounded-full hover:bg-white/20">âœ•</button>
        </div>

        <!-- ä¸»è¦é¡¯ç¤ºå€ -->
        <div class="flex-1 flex flex-col items-center justify-center relative">
            <!-- å¾ªç’°ç‹€æ…‹ -->
            <div id="active-loops"
                class="absolute top-4 text-sm font-mono text-gray-400 bg-black/30 px-3 py-1 rounded-full">
                Loop 1/3
            </div>

            <div class="text-[8rem] font-mono font-black leading-none tracking-tighter tabular-nums"
                id="active-countdown">00</div>
            <div class="text-2xl font-bold mt-2 text-white uppercase tracking-widest" id="active-status">READY
            </div>

            <!-- ç´¯è¨ˆèˆ‡å‰©é¤˜æ™‚é–“ -->
            <div class="flex gap-8 mt-8 text-sm font-mono text-gray-400">
                <div class="text-center">
                    <div class="text-xs uppercase opacity-50">Elapsed</div>
                    <div id="active-elapsed" class="text-white text-lg">00:00</div>
                </div>
                <div class="text-center">
                    <div class="text-xs uppercase opacity-50">Remaining</div>
                    <div id="active-remaining" class="text-white text-lg">00:00</div>
                </div>
            </div>
        </div>

        <!-- ä¸‹ä¸€æ­¥èˆ‡æ§åˆ¶ -->
        <div class="bg-gray-800 p-8 pb-12 rounded-t-3xl shrink-0">
            <!-- ä¸‹ä¸€æ­¥é å‘Š -->
            <div class="flex items-center gap-3 mb-8 bg-gray-700/50 p-3 rounded-xl border border-gray-600/30">
                <div class="text-xs font-bold text-gray-400 uppercase whitespace-nowrap px-2">Next</div>
                <div id="active-next-badge" class="w-3 h-3 rounded-full bg-gray-500"></div>
                <div id="active-next" class="text-white font-bold truncate">Rest (3s)</div>
            </div>

            <div class="grid grid-cols-4 gap-4">
                <!-- ä¸Šä¸€æ­¥ -->
                <button onclick="timer.skip(-1)" class="flex flex-col items-center gap-2 group">
                    <div
                        class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center group-active:scale-95 transition-transform">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                        </svg>
                    </div>
                    <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">ä¸Šä¸€æ­¥</span>
                </button>

                <!-- æš«åœ/ç¹¼çºŒ -->
                <button onclick="timer.toggle()" class="flex flex-col items-center gap-2 group">
                    <div
                        class="w-14 h-14 bg-white text-gray-900 rounded-full flex items-center justify-center shadow-lg group-active:scale-95 transition-transform">
                        <svg id="icon-play-pause" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6">
                            </path>
                        </svg>
                    </div>
                    <span id="lbl-play-pause"
                        class="text-[10px] text-white font-bold uppercase tracking-wider">æš«åœ</span>
                </button>

                <!-- ä¸‹ä¸€æ­¥ -->
                <button onclick="timer.skip(1)" class="flex flex-col items-center gap-2 group">
                    <div
                        class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center group-active:scale-95 transition-transform">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                        </svg>
                    </div>
                    <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">ä¸‹ä¸€æ­¥</span>
                </button>

                <!-- çµæŸ -->
                <button onclick="timer.stop()" class="flex flex-col items-center gap-2 group">
                    <div
                        class="w-12 h-12 bg-red-500/20 text-red-500 rounded-full flex items-center justify-center group-active:scale-95 transition-transform">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 6h12v12H6z" />
                        </svg>
                    </div>
                    <span class="text-[10px] text-red-400 font-bold uppercase tracking-wider">çµæŸ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- è‡ªå‹•å®Œæˆè³‡æ–™æ¸…å–® -->
    <datalist id="history-list"></datalist>

    <script>
        // --- å·¥å…·å‡½å¼ ---
        const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        const formatTime = (s) => {
            const m = Math.floor(s / 60);
            const sec = s % 60;
            return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        };

        // --- Sound & TTS Manager ---
        const soundManager = {
            settings: {
                enabled: true,
                tts: true,
                countdown: 3, // ç§’
                rate: 1.0
            },

            init() {
                const saved = localStorage.getItem('soundSettings');
                if (saved) this.settings = JSON.parse(saved);

                // Bind UI elements
                const bindCheckbox = (id, key) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    el.checked = this.settings[key];
                    el.onchange = (e) => {
                        this.settings[key] = e.target.checked;
                        this.save();
                    };
                };

                bindCheckbox('set-sound-enabled', 'enabled');
                bindCheckbox('set-tts-enabled', 'tts');

                const elCount = document.getElementById('set-countdown-sec');
                if (elCount) {
                    elCount.value = this.settings.countdown;
                    elCount.onchange = (e) => {
                        let val = parseInt(e.target.value);
                        if (isNaN(val) || val < 0) val = 3;
                        this.settings.countdown = val;
                        this.save();
                    }
                }

                const elRate = document.getElementById('set-speech-rate');
                const lblRate = document.getElementById('lbl-speech-rate');
                if (elRate) {
                    elRate.value = this.settings.rate;
                    lblRate.textContent = this.settings.rate + 'x';
                    elRate.oninput = (e) => {
                        this.settings.rate = parseFloat(e.target.value);
                        lblRate.textContent = this.settings.rate + 'x';
                        this.save();
                    }
                }
            },

            save() {
                localStorage.setItem('soundSettings', JSON.stringify(this.settings));
            },

            beep(freq = 880, type = 'sine', duration = 0.1) {
                if (!this.settings.enabled) return;
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContext) return;
                    const ctx = new AudioContext();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = freq;
                    osc.type = type;
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + duration);
                    osc.start();
                    osc.stop(ctx.currentTime + duration);
                } catch (e) { console.error(e); }
            },

            speak(text) {
                if (!this.settings.enabled || !this.settings.tts) return;
                if (!window.speechSynthesis) return;

                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.rate = this.settings.rate;
                u.lang = 'en-US'; // Default to English for better generic pronunciation
                window.speechSynthesis.speak(u);
            }
        };

        // --- Voice Commander ---
        const voiceCommander = {
            recognition: null,
            isListening: false,
            shouldRestart: false,

            init() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.log("Browser does not support Speech Recognition");
                    return;
                }

                this.recognition = new SpeechRecognition();
                this.recognition.continuous = false;
                this.recognition.lang = 'en-US';
                this.recognition.interimResults = false;
                this.recognition.maxAlternatives = 1;

                this.recognition.onstart = () => {
                    this.isListening = true;
                    this.updateUI(true);
                };

                this.recognition.onend = () => {
                    this.isListening = false;
                    if (this.shouldRestart) {
                        try { this.recognition.start(); } catch (e) { }
                    } else {
                        this.updateUI(false);
                    }
                };

                this.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.toLowerCase();
                    console.log("Voice Command:", transcript);
                    this.handleCommand(transcript);
                };
            },

            toggle() {
                if (!this.recognition) return alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æ§åˆ¶");
                if (this.isListening) { this.stop(); } else { this.start(); }
            },

            start() {
                this.shouldRestart = true;
                try { this.recognition.start(); } catch (e) { console.error(e); }
            },

            stop() {
                this.shouldRestart = false;
                try { this.recognition.stop(); } catch (e) { console.error(e); }
            },

            updateUI(isActive) {
                const btn = document.getElementById('btn-mic-toggle');
                if (!btn) return;

                if (isActive) {
                    btn.classList.add('mic-listening');
                    btn.classList.remove('text-white/50');
                    btn.classList.add('text-white');
                } else {
                    btn.classList.remove('mic-listening');
                    btn.classList.add('text-white/50');
                    btn.classList.remove('text-white');
                }
            },

            handleCommand(text) {
                if (text.includes('start') || text.includes('go') || text.includes('resume') || text.includes('begin') || text.includes('é–‹å§‹')) {
                    if (timer.isPaused) timer.toggle();
                }
                else if (text.includes('stop') || text.includes('pause') || text.includes('wait') || text.includes('hold') || text.includes('æš«åœ')) {
                    if (!timer.isPaused) timer.toggle();
                }
                else if (text.includes('next') || text.includes('skip') || text.includes('jump') || text.includes('ä¸‹ä¸€æ­¥')) {
                    timer.skip(1);
                }
                else if (text.includes('back') || text.includes('previous') || text.includes('ä¸Šä¸€æ­¥')) {
                    timer.skip(-1);
                }
                else if (text.includes('finish') || text.includes('exit') || text.includes('end') || text.includes('çµæŸ')) {
                    timer.stop();
                }
            }
        };

        // --- 1. Router ---
        const router = {
            go(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(el => {
                    el.classList.remove('text-gray-900', 'text-blue-600');
                    el.classList.add('text-gray-400');
                });
                document.getElementById(`view-${viewId}`).classList.add('active');
                const btn = document.querySelector(`.nav-btn[data-target="view-${viewId}"]`);
                if (btn) {
                    btn.classList.remove('text-gray-400');
                    btn.classList.add('text-gray-900');
                }
            }
        };

        // --- 2. Store ---
        const store = {
            routines: [],
            user: null,

            init() {
                if (typeof auth !== 'undefined') {
                    auth.onAuthStateChanged(user => {
                        this.user = user;
                        this.updateUserUI();
                        user ? this.loadRoutines() : this.loadLocalRoutines();
                    });
                } else {
                    setTimeout(() => this.init(), 500);
                }
            },

            updateUserUI() {
                const emailEl = document.getElementById('settings-email');
                const btn = document.getElementById('auth-btn');
                const avatar = document.getElementById('avatar-img');
                const placeholder = document.getElementById('avatar-placeholder');

                if (this.user) {
                    emailEl.textContent = this.user.email;
                    btn.textContent = 'ç™»å‡º';
                    btn.onclick = () => auth.signOut();
                    if (this.user.photoURL) {
                        avatar.src = this.user.photoURL;
                        avatar.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                    }
                } else {
                    emailEl.textContent = 'æœªç™»å…¥';
                    btn.textContent = 'ç™»å…¥';
                    btn.onclick = () => {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        auth.signInWithPopup(provider).catch(e => alert(e.message));
                    };
                    avatar.classList.add('hidden');
                    placeholder.classList.remove('hidden');
                }
            },

            async loadRoutines() {
                const list = document.getElementById('routine-list');
                list.innerHTML = '<div class="text-center text-gray-400 mt-4">åŒæ­¥ä¸­...</div>';
                try {
                    const snap = await db.collection('users').doc(this.user.uid).collection('routines').orderBy('updatedAt', 'desc').get();
                    this.routines = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.renderRoutines();
                } catch (e) { console.error(e); }
            },

            loadLocalRoutines() {
                const saved = localStorage.getItem('localRoutines');
                this.routines = saved ? JSON.parse(saved) : [];
                this.renderRoutines();
            },

            async deleteRoutine(id) {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹èª²è¡¨å—ï¼Ÿ')) return;

                if (this.user) {
                    await db.collection('users').doc(this.user.uid).collection('routines').doc(id).delete();
                    this.loadRoutines();
                } else {
                    this.routines = this.routines.filter(r => r.id !== id);
                    localStorage.setItem('localRoutines', JSON.stringify(this.routines));
                    this.renderRoutines();
                }
            },

            renderRoutines() {
                const list = document.getElementById('routine-list');
                list.innerHTML = '';
                if (this.routines.length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-400 mt-10">å°šç„¡èª²è¡¨ï¼Œé»æ“Šå³ä¸Šè§’ + æ–°å¢</div>';
                    return;
                }

                this.routines.forEach(r => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center group";
                    const blockCount = r.blocks ? r.blocks.length : 0;

                    el.innerHTML = `
                        <div onclick="timer.start('${r.id}')" class="flex-1 cursor-pointer">
                            <div class="font-bold text-lg text-gray-800">${r.title}</div>
                            <div class="text-xs text-gray-500 mt-1">${blockCount} å€‹å€å¡Š</div>
                        </div>
                        <div class="flex items-center gap-3">
                             <button onclick="editor.load('${r.id}')" class="text-gray-400 hover:text-blue-600 p-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                            <button onclick="store.deleteRoutine('${r.id}')" class="text-gray-400 hover:text-red-600 p-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    list.appendChild(el);
                });
            }
        };

        // --- 3. Editor ---
        const editor = {
            currentId: null,
            activeBlock: null,
            // é¡è‰²åˆ—è¡¨
            colors: ['gray', 'red', 'orange', 'amber', 'green', 'teal', 'blue', 'indigo', 'violet', 'pink'],
            // æš«å­˜é¸æ“‡çš„é¡è‰²
            selectedColor: 'gray',

            // é è¨­é¸é … (çµ±ä¸€ç‚º Title Case English)
            defaultSuggestions: {
                'timer': [
                    { label: 'Prepare', color: 'blue' },
                    { label: 'Hang', color: 'orange' },
                    { label: 'Rest', color: 'green' }
                ],
                'reps': [
                    { label: 'Pull Ups', color: 'indigo' },
                    { label: 'Push Ups', color: 'pink' }
                ],
                'loop': []
            },

            init() {
                new Sortable(document.getElementById('editor-palette'), {
                    group: { name: 'shared', pull: 'clone', put: false },
                    sort: false,
                    onClone: (evt) => { evt.clone.dataset.tempId = Date.now(); }
                });
                this.initSortable(document.getElementById('editor-canvas'));
            },

            initSortable(el) {
                new Sortable(el, {
                    group: 'shared',
                    animation: 150,
                    fallbackOnBody: true,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    draggable: '.block-item', // é™åˆ¶åªæœ‰ block-item å¯ä»¥æ‹–æ›³
                    onAdd: (evt) => {
                        const type = evt.item.dataset.type;
                        evt.item.replaceWith(this.createBlock({ type, id: uuid() }));
                    }
                });
            },

            // å–å¾—ç©æœ¨é¡åˆ¥ (æ ¹æ“š props.color)
            getBlockClass(type, props) {
                const c = props.color || 'gray';
                return `border-l-4 border-l-${c}-500 bg-${c}-50 border-${c}-200`;
            },

            createBlock(data) {
                const el = document.createElement('div');
                const props = data.props || this.getDefaultProps(data.type);

                el.className = `block-item p-3 mb-2 rounded border bg-white ${this.getBlockClass(data.type, props)}`;
                el.dataset.type = data.type;
                el.dataset.id = data.id || uuid();
                el.dataset.props = JSON.stringify(props);

                const header = document.createElement('div');
                header.className = "flex justify-between items-center cursor-pointer";
                header.innerHTML = `
                    <div class="flex items-center gap-2 pointer-events-none">
                        <span class="text-xs font-bold uppercase opacity-60">${data.type}</span>
                        <span class="font-bold text-sm block-label">${this.getLabel(data.type, props)}</span>
                    </div>
                `;
                header.onclick = (e) => {
                    e.stopPropagation();
                    this.openProps(el);
                };
                el.appendChild(header);

                if (data.type === 'loop') {
                    const inner = document.createElement('div');
                    inner.className = "nested-container pl-2 pr-2 pb-2 pt-2";
                    el.appendChild(inner);
                    this.initSortable(inner);
                    if (data.children) {
                        data.children.forEach(c => inner.appendChild(this.createBlock(c)));
                    }
                }

                return el;
            },

            getDefaultProps(type) {
                if (type === 'loop') return { iterations: 3, color: 'violet' };
                if (type === 'timer') return { duration: 10, label: 'Hang', color: 'orange' };
                if (type === 'reps') return { count: 5, duration: 30, label: 'Pull Ups', color: 'blue' };
                return { color: 'gray' };
            },

            getLabel(type, props) {
                if (type === 'loop') return `x ${props.iterations} æ¬¡`;
                if (type === 'timer') return `${props.label} (${props.duration}s)`;
                if (type === 'reps') return `${props.label} x${props.count}`;
                return type;
            },

            // æƒææ‰€æœ‰èª²è¡¨ï¼Œå»ºç«‹æ­·å²ç´€éŒ„ (Name -> Color)
            getHistory(type) {
                const history = new Map();
                store.routines.forEach(r => {
                    const traverse = (blocks) => {
                        blocks.forEach(b => {
                            if (b.type === type && b.props.label) {
                                history.set(b.props.label, b.props.color || 'gray');
                            }
                            if (b.children) traverse(b.children);
                        });
                    };
                    if (r.blocks) traverse(r.blocks);
                });
                return history;
            },

            openProps(el) {
                this.activeBlock = el;
                const type = el.dataset.type;
                const props = JSON.parse(el.dataset.props);
                const form = document.getElementById('prop-form');

                // 1. ç”Ÿæˆè¡¨å–®å…§å®¹
                let html = '';
                if (type !== 'loop') {
                    // Create Options String for Select
                    let optionsHtml = '<option value="" disabled selected>Select from history...</option>';

                    const historyMap = this.getHistory(type);
                    const defaults = this.defaultSuggestions[type] || [];

                    // Add Defaults to history map for color lookup
                    defaults.forEach(def => {
                        if (!historyMap.has(def.label)) historyMap.set(def.label, def.color);
                    });

                    // Build Options (Unique)
                    const addedLabels = new Set();

                    // Add Defaults
                    defaults.forEach(def => {
                        optionsHtml += `<option value="${def.label}">${def.label}</option>`;
                        addedLabels.add(def.label);
                    });

                    // Add History
                    historyMap.forEach((color, label) => {
                        if (!addedLabels.has(label)) {
                            optionsHtml += `<option value="${label}">${label}</option>`;
                        }
                    });

                    html += `
                        <div>
                            <label class="block text-sm font-bold text-gray-500 mb-1">æ¨™ç±¤ (Label)</label>
                            <div class="flex flex-col gap-2">
                                <input type="text" id="inp-label" class="w-full border rounded-lg p-3" value="${props.label || ''}" placeholder="Type custom name...">
                                <select id="sel-label" class="w-full border rounded-lg p-2 text-sm text-gray-600 bg-gray-50">
                                    ${optionsHtml}
                                </select>
                            </div>
                        </div>`;

                    // Store map for color lookup in event listener
                    this.tempHistoryMap = historyMap;
                }

                if (type === 'loop') {
                    html += `
                    <div>
                        <label class="block text-sm font-bold text-gray-500 mb-1">å¾ªç’°æ¬¡æ•¸</label>
                        <input type="number" id="inp-iterations" class="w-full border rounded-lg p-3 text-lg" value="${props.iterations}">
                    </div>`;
                } else if (type === 'timer') {
                    html += `
                    <div>
                        <label class="block text-sm font-bold text-gray-500 mb-1">æ™‚é–“ (ç§’)</label>
                        <input type="number" id="inp-duration" class="w-full border rounded-lg p-3 text-lg" value="${props.duration}">
                    </div>`;
                } else if (type === 'reps') {
                    html += `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-500 mb-1">æ¬¡æ•¸ (Reps)</label>
                            <input type="number" id="inp-count" class="w-full border rounded-lg p-3 text-lg" value="${props.count}">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-500 mb-1">é ä¼°æ™‚é–“ (ç§’)</label>
                            <input type="number" id="inp-duration" class="w-full border rounded-lg p-3 text-lg" value="${props.duration}" placeholder="è¨ˆæ™‚ç”¨">
                        </div>
                    </div>`;
                }
                form.innerHTML = html;

                // 2. ç”Ÿæˆé¡è‰²é¸æ“‡å™¨
                this.selectedColor = props.color || 'gray';
                const palette = document.getElementById('color-palette');
                palette.innerHTML = '';
                this.colors.forEach(c => {
                    const btn = document.createElement('div');
                    btn.className = `color-btn w-8 h-8 rounded-full cursor-pointer shrink-0 bg-${c}-500 ${c === this.selectedColor ? 'selected' : ''}`;
                    btn.onclick = () => {
                        this.selectedColor = c;
                        // Update UI selection
                        Array.from(palette.children).forEach(child => child.classList.remove('selected'));
                        btn.classList.add('selected');
                    };
                    palette.appendChild(btn);
                });

                // 3. ç¶å®šäº‹ä»¶ (Select -> Input & Color)
                const selLabel = document.getElementById('sel-label');
                const inpLabel = document.getElementById('inp-label');

                if (selLabel && inpLabel) {
                    selLabel.addEventListener('change', (e) => {
                        const val = e.target.value;
                        inpLabel.value = val;

                        // Auto-select color
                        if (this.tempHistoryMap && this.tempHistoryMap.has(val)) {
                            const historyColor = this.tempHistoryMap.get(val);
                            this.selectedColor = historyColor;
                            // Update Palette UI
                            Array.from(palette.children).forEach(child => {
                                child.classList.remove('selected');
                                if (child.classList.contains(`bg-${historyColor}-500`)) {
                                    child.classList.add('selected');
                                }
                            });
                        }
                    });
                }

                document.getElementById('prop-sheet').classList.remove('translate-y-full');
            },

            saveProps() {
                if (!this.activeBlock) return;
                const type = this.activeBlock.dataset.type;
                let props = JSON.parse(this.activeBlock.dataset.props);

                // æ›´æ–°åŸºæœ¬å±¬æ€§
                if (type === 'loop') {
                    props.iterations = Number(document.getElementById('inp-iterations').value);
                } else {
                    props.label = document.getElementById('inp-label').value;
                    props.duration = Number(document.getElementById('inp-duration').value);
                    if (type === 'reps') props.count = Number(document.getElementById('inp-count').value);
                }

                // æ›´æ–°é¡è‰²
                props.color = this.selectedColor;

                // å¯«å› DOM
                this.activeBlock.dataset.props = JSON.stringify(props);
                this.activeBlock.className = `block-item p-3 mb-2 rounded border bg-white ${this.getBlockClass(type, props)}`;
                this.activeBlock.querySelector('.block-label').textContent = this.getLabel(type, props);
                this.closeProps();
            },

            deleteCurrentBlock() {
                if (this.activeBlock) {
                    this.activeBlock.remove();
                    this.closeProps();
                }
            },

            closeProps() {
                document.getElementById('prop-sheet').classList.add('translate-y-full');
                this.activeBlock = null;
            },

            serialize(container = document.getElementById('editor-canvas')) {
                const blocks = [];
                Array.from(container.children).forEach(el => {
                    if (!el.classList.contains('block-item')) return;
                    const block = {
                        id: el.dataset.id,
                        type: el.dataset.type,
                        props: JSON.parse(el.dataset.props)
                    };
                    if (block.type === 'loop') {
                        const inner = el.querySelector('.nested-container');
                        block.children = this.serialize(inner);
                    }
                    blocks.push(block);
                });
                return blocks;
            },

            open() {
                this.currentId = null;
                document.getElementById('editor-title').value = '';
                document.getElementById('editor-canvas').innerHTML = '<div class="text-center text-gray-400 mt-20 text-sm pointer-events-none">å¾ä¸‹æ–¹æ‹–æ›³ç©æœ¨è‡³æ­¤</div>';
                document.getElementById('modal-editor').classList.add('open');

                // NEW: Reset checkbox
                this.appendFooter(false);
            },

            load(id) {
                const r = store.routines.find(x => x.id === id);
                if (!r) return;
                this.currentId = id;
                document.getElementById('editor-title').value = r.title;
                const canvas = document.getElementById('editor-canvas');
                canvas.innerHTML = '';
                if (r.blocks) {
                    r.blocks.forEach(b => canvas.appendChild(this.createBlock(b)));
                }
                document.getElementById('modal-editor').classList.add('open');

                // NEW: Load checkbox state
                this.appendFooter(!!r.skipLastRest);
            },

            appendFooter(isChecked) {
                const container = document.getElementById('editor-canvas');
                const footer = document.createElement('div');
                footer.className = "mt-6 flex items-center justify-center gap-3 opacity-80 hover:opacity-100 transition-opacity";
                footer.innerHTML = `
                    <label for="editor-skip-rest" class="text-sm font-bold text-gray-500 cursor-pointer">è·³éæœ€å¾Œä¼‘æ¯</label>
                    <div class="relative inline-block w-12 align-middle select-none">
                        <input type="checkbox" id="editor-skip-rest" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300" ${isChecked ? 'checked' : ''}/>
                        <label for="editor-skip-rest" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                `;
                container.appendChild(footer);
            },

            close() { document.getElementById('modal-editor').classList.remove('open'); },

            async save() {
                const title = document.getElementById('editor-title').value || 'æœªå‘½åèª²è¡¨';
                const blocks = this.serialize();
                // NEW: Save checkbox
                const skipLastRest = document.getElementById('editor-skip-rest') ? document.getElementById('editor-skip-rest').checked : false;

                const data = { title, blocks, skipLastRest, updatedAt: Date.now() };

                if (store.user) {
                    const col = db.collection('users').doc(store.user.uid).collection('routines');
                    this.currentId ? await col.doc(this.currentId).set(data, { merge: true }) : await col.add(data);
                    store.loadRoutines();
                } else {
                    const newId = this.currentId || 'local_' + Date.now();
                    const idx = store.routines.findIndex(r => r.id === newId);
                    if (idx > -1) store.routines[idx] = { id: newId, ...data };
                    else store.routines.unshift({ id: newId, ...data });
                    localStorage.setItem('localRoutines', JSON.stringify(store.routines));
                    store.renderRoutines();
                }
                this.close();
            }
        };

        // --- 4. Timer Engine (æ ¸å¿ƒé‚è¼¯) ---
        const timer = {
            queue: [],
            totalDuration: 0,
            currentIndex: 0,
            elapsed: 0,
            interval: null,
            isPaused: false,

            flatten(blocks, parentLoops = []) {
                let res = [];
                blocks.forEach(b => {
                    if (b.type === 'loop') {
                        const count = b.props.iterations || 1;
                        for (let i = 1; i <= count; i++) {
                            const currentLoopInfo = { current: i, total: count };
                            const newParentLoops = [...parentLoops, currentLoopInfo];
                            res = res.concat(this.flatten(b.children || [], newParentLoops));
                        }
                    } else {
                        res.push({
                            ...b,
                            loopState: parentLoops
                        });
                    }
                });
                return res;
            },

            start(routineId) {
                const routine = store.routines.find(r => r.id === routineId);
                if (!routine || !routine.blocks) return;

                this.queue = this.flatten(routine.blocks);

                // *** ä¿®æ”¹ï¼šå¥—ç”¨ Skip Last Timer é‚è¼¯ (Based on Type) ***
                if (routine.skipLastRest && this.queue.length > 0) {
                    const last = this.queue[this.queue.length - 1];
                    // åªè¦æœ€å¾Œä¸€å€‹æ˜¯è¨ˆæ™‚é¡å‹ (Timer)ï¼Œå°±ç§»é™¤
                    if (last.type === 'timer') {
                        this.queue.pop(); // ç§»é™¤æœ€å¾Œä¸€é …
                    }
                }

                if (this.queue.length === 0) return alert('èª²è¡¨æ˜¯ç©ºçš„');

                // åƒ…åŠ å…¥çµæŸæ¨™è¨˜
                this.queue.push({ type: 'finish', props: { duration: 0, label: 'Done', color: 'gray' }, loopState: [] });

                this.totalDuration = this.queue.reduce((acc, item) => acc + (item.props.duration || 0), 0);
                this.currentIndex = 0;
                this.elapsed = 0;
                this.isPaused = false;

                document.getElementById('active-title').textContent = routine.title;
                document.getElementById('modal-active-timer').classList.add('open');

                this.updateControlUI();
                this.runStep();
                this.startTicker();
                voiceCommander.init();
            },

            runStep() {
                const step = this.queue[this.currentIndex];
                if (!step) return this.stop();

                this.stepDuration = step.props.duration || 0;
                this.stepLeft = this.stepDuration;

                document.getElementById('active-status').textContent = step.props.label;

                const statusEl = document.getElementById('active-status');
                const modalEl = document.getElementById('modal-active-timer');

                // *** ä¿®æ”¹ï¼šèƒŒæ™¯è‰²ä½¿ç”¨ props.color ***
                const color = step.props.color || 'gray';

                // Reset classes: remove all bg-*
                modalEl.className = `modal fixed inset-0 z-[60] flex flex-col open transition-colors duration-500 bg-${color}-600`;

                // èª¿æ•´æ–‡å­—é¡è‰²ï¼ˆé™¤äº† finish å¤–é€šå¸¸æ˜¯ white/lightï¼‰
                if (step.type === 'finish') {
                    statusEl.textContent = "FINISHED";
                    this.stop();
                    return;
                } else {
                    // å¤§éƒ¨åˆ†æ·±è‰²èƒŒæ™¯ä½¿ç”¨ç™½è‰²æ–‡å­—
                    statusEl.className = "text-2xl font-bold mt-2 text-white uppercase tracking-widest";
                }

                // TTS æœ—è®€
                soundManager.speak(step.props.label);

                this.updateDisplay();
            },

            startTicker() {
                if (this.interval) clearInterval(this.interval);
                this.interval = setInterval(() => {
                    if (this.isPaused) return;

                    if (this.stepLeft > 0) {
                        this.stepLeft--;
                        this.elapsed++;

                        // å€’æ•¸æç¤ºéŸ³ (Beep)
                        if (this.stepLeft <= soundManager.settings.countdown) {
                            soundManager.beep(440, 'sine', 0.1);
                        }

                    } else {
                        // è½‰æ›æç¤ºéŸ³ (High Beep)
                        soundManager.beep(880, 'square', 0.2);

                        this.currentIndex++;
                        if (this.currentIndex < this.queue.length) {
                            this.runStep();
                        } else {
                            this.stop();
                        }
                    }
                    this.updateDisplay();
                }, 1000);
            },

            updateDisplay() {
                const step = this.queue[this.currentIndex];

                const displayNum = step.type === 'reps' && this.stepLeft > 0
                    ? `${step.props.count}<span class="text-4xl ml-2 opacity-50">reps</span>`
                    : (this.stepLeft < 10 ? '0' + this.stepLeft : this.stepLeft);

                document.getElementById('active-countdown').innerHTML = displayNum;

                const remaining = Math.max(0, this.totalDuration - this.elapsed);
                document.getElementById('active-elapsed').textContent = formatTime(this.elapsed);
                document.getElementById('active-remaining').textContent = formatTime(remaining);
                document.getElementById('active-total-time').textContent = `Total: ${formatTime(this.totalDuration)}`;

                const loopState = step.loopState;
                const loopEl = document.getElementById('active-loops');
                if (loopState && loopState.length > 0) {
                    const text = loopState.map(l => `Loop ${l.current}/${l.total}`).join(' > ');
                    loopEl.textContent = text;
                    loopEl.classList.remove('hidden');
                } else {
                    loopEl.classList.add('hidden');
                }

                // ä¸‹ä¸€æ­¥é å‘Šèˆ‡é¡è‰²é»
                const nextStep = this.queue[this.currentIndex + 1];
                const nextEl = document.getElementById('active-next');
                const nextBadge = document.getElementById('active-next-badge');
                if (nextStep) {
                    let desc = nextStep.props.label;
                    if (nextStep.type === 'timer') desc += ` (${nextStep.props.duration}s)`;
                    if (nextStep.type === 'reps') desc += ` x${nextStep.props.count}`;
                    nextEl.textContent = desc;

                    // ä¸‹ä¸€æ­¥é¡è‰²
                    const nc = nextStep.props.color || 'gray';
                    nextBadge.className = `w-3 h-3 rounded-full bg-${nc}-400`;
                } else {
                    nextEl.textContent = "Finish";
                    nextBadge.className = `w-3 h-3 rounded-full bg-gray-500`;
                }
            },

            toggle() {
                this.isPaused = !this.isPaused;
                this.updateControlUI();
            },

            updateControlUI() {
                const iconEl = document.getElementById('icon-play-pause');
                const labelEl = document.getElementById('lbl-play-pause');

                if (this.isPaused) {
                    iconEl.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>';
                    labelEl.textContent = 'ç¹¼çºŒ';
                } else {
                    iconEl.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6"></path>';
                    labelEl.textContent = 'æš«åœ';
                }
            },

            skip(dir) {
                const newIndex = this.currentIndex + dir;
                if (newIndex >= 0 && newIndex < this.queue.length) {
                    this.currentIndex = newIndex;
                    this.runStep();
                }
            },

            stop() {
                clearInterval(this.interval);
                voiceCommander.stop();
                document.getElementById('modal-active-timer').classList.remove('open');
            }
        };

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            store.init();
            editor.init();
            soundManager.init();

            const calGrid = document.getElementById('calendar-grid');
            for (let i = 0; i < 28; i++) {
                const d = document.createElement('div');
                d.className = `aspect-square rounded-full flex items-center justify-center text-xs ${Math.random() > 0.7 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-400'}`;
                d.textContent = i + 1;
                calGrid.appendChild(d);
            }
        });

    </script>
</body>

</html>