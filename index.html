<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’æ§åˆ¶ä¸­å¿ƒ</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, sans-serif;
        }

        body {
            background-color: #0b1220;
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card {
            background: #111827;
            width: 100%;
            max-width: 500px;
            padding: 20px;
            border-radius: 20px;
            border: 1px solid #1f2937;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #22d3ee;
            text-align: center;
        }

        label {
            font-size: 13px;
            color: #cbd5e1;
            margin-top: 15px;
            display: block;
        }

        select,
        input,
        button {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            border-radius: 12px;
            border: 1px solid #1f2937;
            background: #0b1220;
            color: white;
            font-size: 16px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 500px;
        }

        .nav-box {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-decoration: none;
            font-weight: bold;
            border-radius: 15px;
            aspect-ratio: 1/1;
            transition: 0.2s;
        }

        .box-1 {
            background: linear-gradient(135deg, #FF9500, #FF3B30);
        }

        .box-2 {
            background: linear-gradient(135deg, #34C759, #007AFF);
        }

        .hidden {
            display: none !important;
        }

        #statusMsg {
            font-size: 12px;
            color: #22d3ee;
            margin-top: 8px;
            text-align: center;
            display: block;
        }
    </style>
</head>

<body>
    <h1>å­¸ç¿’æ§åˆ¶ä¸­å¿ƒ</h1>
    <div class="card">
        <div id="loginSection">
            <button id="loginBtn" style="background: #0ea5e9; color: #000; font-weight: bold;">ä½¿ç”¨ Google ç™»å…¥åŒæ­¥</button>
        </div>
        <div id="logoutSection" class="hidden">
            <p id="userInfo" style="font-size:12px; text-align:center; color:#aaa;"></p>
            <button id="logoutBtn"
                style="background: #ef4444; color: white; padding: 8px; font-size: 12px; margin-top:8px;">ç™»å‡ºå¸³è™Ÿ</button>
        </div>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #1f2937;">
        <label>OpenAI API Key (ç”¨æ–¼ IPA èˆ‡ AI å‡ºé¡Œ)</label>
        <input type="password" id="globalKey" placeholder="sk-...">
        <button id="saveKeyBtn" style="background: #22d3ee; color: #000; font-weight: bold;">å„²å­˜æ‰€æœ‰è¨­å®š</button>
        <span id="statusMsg"></span>
        <label>ç›®æ¨™å­¸ç¿’èªè¨€</label>
        <select id="globalLang">
            <option value="en-US">English ğŸ‡ºğŸ‡¸</option>
            <option value="it-IT">Italiano ğŸ‡®ğŸ‡¹</option>
            <option value="zh-TW">ä¸­æ–‡ (ç¹é«”) ğŸ‡¹ğŸ‡¼</option>
            <option value="ja-JP">æ—¥æœ¬èª ğŸ‡¯ğŸ‡µ</option>
            <option value="fr-FR">FranÃ§ais ğŸ‡«ğŸ‡·</option>
            <option value="de-DE">Deutsch ğŸ‡©ğŸ‡ª</option>
            <option value="es-ES">EspaÃ±ol ğŸ‡ªğŸ‡¸</option>
            <option value="pt-PT">PortuguÃªs ğŸ‡µğŸ‡¹</option>
            <option value="ru-RU">Ğ ÑƒÑÑĞºĞ¸Ğ¹ ğŸ‡·ğŸ‡º</option>
            <option value="hi-IN">à¤¹à¤¿à¤¨à¥à¤¦à¥€ / Ø§ÙØ±Ø¯ÙÙˆ ğŸ‡®ğŸ‡³</option>
            <option value="bn-BD">à¦¬à¦¾à¦‚à¦²à¦¾ ğŸ‡§ğŸ‡©</option>
            <option value="fa-IR">ÙØ§Ø±Ø³ÛŒ ğŸ‡®ğŸ‡·</option>
            <option value="ta-IN">à®¤à®®à®¿à®´à¯ ğŸ‡®ğŸ‡³</option>
            <option value="ar-SA">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ğŸ‡¸ğŸ‡¦</option>
            <option value="tr-TR">TÃ¼rkÃ§e ğŸ‡¹ğŸ‡·</option>
            <option value="ko-KR">í•œêµ­ì–´ ğŸ‡°ğŸ‡·</option>
            <option value="vi-VN">Tiáº¿ng Viá»‡t ğŸ‡»ğŸ‡³</option>
            <option value="id-ID">Bahasa Indonesia / Melayu ğŸ‡®ğŸ‡©</option>
            <option value="th-TH">à¹„à¸—à¸¢ ğŸ‡¹ğŸ‡­</option>
            <option value="sw-KE">Kiswahili ğŸ‡°ğŸ‡ª</option>
        </select>
        <label>å­¸ç¿’èª²ç¨‹é€²åº¦</label>
        <select id="globalCourse">
            <option value="all">å…¨éƒ¨å–®å­—</option>
            <option value="Stage 1">Stage 1: Core 40 (æ ¸å¿ƒè©)</option>
            <option value="Stage 2">Stage 2: Swadesh (åŸºç¤è©)</option>
            <option value="Stage 3">Stage 3: CEFR (åˆ†ç´šå–®å­—)</option>
        </select>
    </div>
    <div class="grid">
        <a href="test1.html" class="nav-box box-1"><span>âœï¸ æ‰‹å¯«ç·´ç¿’</span></a>
        <a href="test2.html" class="nav-box box-2"><span>ğŸ§© èªæ³•æ’åº</span></a>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBqZLFskqgyiAEc127dh95rXsOPQVLSurM",
            authDomain: "test-5dbba.firebaseapp.com", // ä¿®æ­£ï¼šç™»å…¥å¿…è¦åƒæ•¸
            projectId: "test-5dbba"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const keyInput = document.getElementById('globalKey');
        const langInput = document.getElementById('globalLang');
        const courseInput = document.getElementById('globalCourse');
        const statusMsg = document.getElementById('statusMsg');

        const saveAllSettings = async () => {
            const key = keyInput.value.trim();
            const lang = langInput.value;
            const course = courseInput.value;

            // âœ… æ–°å¢ï¼šç«‹å³å­˜å…¥æœ¬åœ°ï¼Œç¢ºä¿å…¶ä»–åˆ†é ï¼ˆtest1, test2ï¼‰èƒ½ç«‹åˆ»è®€åˆ°
            localStorage.setItem('gptApiKey', key);
            localStorage.setItem('userLang', lang);
            localStorage.setItem('userCourse', course);

            const user = auth.currentUser;
            if (user) {
                try {
                    await db.collection('users').doc(user.uid).set({
                        gptApiKey: key,
                        userLang: lang,
                        userCourse: course,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    alert("è¨­å®šå·²å„²å­˜è‡³é›²ç«¯èˆ‡æœ¬åœ°ï¼");
                } catch (e) {
                    alert("é›²ç«¯å„²å­˜å¤±æ•—ï¼š" + e.message);
                }
            } else {
                alert("è¨­å®šå·²å„²å­˜è‡³æœ¬åœ°ï¼ˆæœªç™»å…¥é›²ç«¯ï¼‰");
            }
        }
        document.getElementById('saveKeyBtn').onclick = saveAllSettings;
        langInput.onchange = saveAllSettings;
        courseInput.onchange = saveAllSettings;

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('logoutSection').classList.remove('hidden');
                document.getElementById('userInfo').textContent = `å·²ç™»å…¥ï¼š${user.email}`;
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.gptApiKey) { keyInput.value = data.gptApiKey; localStorage.setItem('gptApiKey', data.gptApiKey); }
                        if (data.userLang) { langInput.value = data.userLang; localStorage.setItem('userLang', data.userLang); }
                        if (data.userCourse) { courseInput.value = data.userCourse; localStorage.setItem('userCourse', data.userCourse); }
                    }
                });
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('logoutSection').classList.add('hidden');
                keyInput.value = localStorage.getItem('gptApiKey') || '';
            }
        });

        document.getElementById('loginBtn').onclick = () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(err => alert("ç™»å…¥å¤±æ•—ï¼š" + err.message));
        };
        document.getElementById('logoutBtn').onclick = () => {
            // 1. æ¸…é™¤ Firebase ç™»å…¥ç‹€æ…‹
            auth.signOut().then(() => {
                // 2. å¼·åˆ¶æ¸…é™¤æœ¬åœ°å„²å­˜çš„æ•æ„Ÿè³‡æ–™
                localStorage.removeItem('gptApiKey');
                localStorage.removeItem('userLang');
                localStorage.removeItem('userCourse');

                // 3. æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦é€šçŸ¥ä½¿ç”¨è€…
                document.getElementById('globalKey').value = '';
                alert("å·²ç™»å‡ºä¸¦æ¸…é™¤æœ¬åœ°è¨­å®šç´€éŒ„");
                location.reload(); // é‡æ–°æ•´ç†é é¢ä»¥ç¢ºä¿ç‹€æ…‹é‡ç½®
            });
        };
    </script>
</body>

</html>