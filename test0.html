<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>éŸ³ä½è¨ºæ–· - åš´æ ¼æ¯”å°æ•´åˆç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script>
    <style>
        :root {
            --bg: #0b1220;
            --card: #111827;
            --text: #e5e7eb;
            --accent: #22d3ee;
            --btn: #0ea5e9;
            --danger: #ef4444;
            --success: #10b981;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: sans-serif;
            padding: 20px;
        }

        .wrap {
            max-width: 680px;
            margin: 0 auto;
        }

        .app {
            background: var(--card);
            border: 1px solid #1f2937;
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #334155;
            padding-bottom: 10px;
        }

        .back-link {
            color: var(--accent);
            text-decoration: none;
            font-size: 14px;
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            max-height: 180px;
            overflow-y: auto;
            padding: 5px;
        }

        .chip {
            padding: 8px 12px;
            border-radius: 12px;
            background: #1f2937;
            color: #cbd5e1;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
            min-width: 70px;
            text-align: center;
        }

        .chip:hover {
            border-color: var(--accent);
            background: #2d3748;
        }

        .chip .pos-tag {
            font-size: 9px;
            color: var(--accent);
            text-transform: uppercase;
            opacity: 0.8;
            display: block;
        }

        #wordDisplay {
            font-size: 42px;
            font-weight: bold;
            color: var(--accent);
            text-align: center;
            margin: 20px 0 5px 0;
        }

        #ipaDisplay {
            color: #94a3b8;
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            font-family: monospace;
        }

        .record-container {
            text-align: center;
            margin: 20px 0;
        }

        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--danger);
            border: none;
            cursor: pointer;
            font-size: 30px;
            margin: 10px auto;
            display: block;
        }

        .record-btn.active {
            animation: pulse 1.5s infinite;
            background: #991b1b;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* å­—ç¬¦å°æ¯”é¡¯ç¤ºå€ */
        #ipa-result {
            text-align: center;
            font-size: 36px;
            margin: 25px 0;
            font-family: 'Charis SIL', 'Segoe UI', monospace;
            letter-spacing: 4px;
        }

        .char-correct {
            color: var(--success);
        }

        .char-wrong {
            color: var(--danger);
            text-decoration: underline;
            cursor: help;
        }

        .ph-block {
            display: inline-block;
            padding: 8px 14px;
            background: #1f2937;
            border-radius: 10px;
            cursor: pointer;
            margin: 5px;
            border: 1px solid #334155;
            font-size: 16px;
        }

        #diag-box {
            background: #0b1220;
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #1f2937;
            display: none;
            font-size: 14px;
            line-height: 1.6;
        }

        .action-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button.action-btn {
            flex: 1;
            border-radius: 14px;
            padding: 15px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            font-size: 15px;
        }

        .primary {
            background: var(--btn);
            color: #000;
        }

        .secondary {
            background: #374151;
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="app">
            <div class="header">
                <a href="index.html" class="back-link">â† è¿”å›æ§åˆ¶ä¸­å¿ƒ</a>
                <span id="langDisplay" style="font-size: 12px; color: #94a3b8;">è¼‰å…¥ä¸­...</span>
            </div>

            <div id="status" style="font-size: 12px; text-align: center; margin-bottom: 5px; color: #6b7280;">å°šæœªç™»å…¥</div>

            <div class="chips" id="samples"></div>

            <div id="wordDisplay">é¸æ“‡å–®å­—é–‹å§‹</div>
            <div id="ipaDisplay">[ æ¨™æº– IPA ]</div>

            <div class="record-container">
                <div id="timer" style="color:#6b7280; font-size:14px;">00:00 / 00:05</div>
                <button class="record-btn" id="recordBtn">ğŸ¤</button>
                <div id="recordStatus" style="font-size: 13px; color: var(--accent); margin-top: 10px;">é»æ“ŠéŒ„éŸ³ (é™æ™‚ 5 ç§’)
                </div>
            </div>

            <div id="ipa-result"></div>

            <div id="phoneme-wrap" style="text-align: center; margin: 15px 0;"></div>

            <div id="diag-box">
                <div id="diag-content"></div>
            </div>

            <div class="action-group">
                <button onclick="speakCurrentWord()" class="action-btn primary">â–¶ æ’­æ”¾æ¨™æº–ç¯„ä¾‹éŸ³</button>
                <button id="replayBtn" onclick="playLastRecording()" class="action-btn secondary" disabled>ğŸ‘‚
                    å›æ’­æˆ‘çš„éŒ„éŸ³</button>
            </div>
        </div>
    </div>

    <script>
        const ALLOSAURUS_API = "https://allosaurus-api-878665537417.asia-east1.run.app/recognize";
        const firebaseConfig = { apiKey: "AIzaSyBqZLFskqgyiAEc127dh95rXsOPQVLSurM", authDomain: "test-5dbba.firebaseapp.com", projectId: "test-5dbba" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(), auth = firebase.auth();

        let audioContext, recorder, gumStream, timerInterval, seconds = 0;
        let currentTargetReading = "", lastRecordingUrl = null;

        const getGlobalSettings = () => ({
            lang: localStorage.getItem('userLang') || 'en-US',
            key: localStorage.getItem('gptApiKey') || '',
            course: localStorage.getItem('userCourse') || 'all'
        });

        auth.onAuthStateChanged(user => {
            document.getElementById('status').textContent = user ? `å­¸ç¿’è€…ï¼š${user.email.split('@')[0]}` : "å°šæœªç™»å…¥";
            document.getElementById('langDisplay').textContent = `ç›®æ¨™èªè¨€ï¼š${getGlobalSettings().lang}`;
            loadSwadeshCSV();
        });

        async function loadSwadeshCSV() {
            try {
                const resp = await fetch('swadesh.csv');
                const text = await resp.text();
                window.allWordData = Papa.parse(text, { header: true, skipEmptyLines: true }).data;
                renderChips();
            } catch (e) { console.error("CSV åŠ è¼‰å‡ºéŒ¯", e); }
        }

        async function getTranslatedWord(englishWord, pos, targetLang) {
            if (targetLang.startsWith('en')) return { text: englishWord, reading: englishWord };
            const cacheId = `trans_${targetLang}_${englishWord}_${pos}`.replace(/[\/\.#$\[\]\s]/g, '_');
            const transRef = db.collection('translation_cache').doc(cacheId);
            const cacheDoc = await transRef.get();
            if (cacheDoc.exists && cacheDoc.data().reading) return cacheDoc.data();

            const settings = getGlobalSettings();
            if (!settings.key) return { text: englishWord, reading: englishWord };

            const prompt = `Translate "${englishWord}" (${pos}) into ${targetLang}. JSON format: {"text": "word to write", "reading": "phonetic reading"}.`;
            try {
                const resp = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${settings.key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [{ role: "user", content: prompt }],
                        response_format: { type: "json_object" }
                    })
                });
                const data = await resp.json();
                const result = JSON.parse(data.choices[0].message.content);
                await transRef.set({ text: result.text, reading: result.reading, lang: targetLang });
                return result;
            } catch (e) { return { text: englishWord, reading: englishWord }; }
        }

        async function renderChips() {
            const settings = getGlobalSettings();
            const container = document.getElementById('samples');
            container.innerHTML = '';

            window.allWordData.filter(row => row['en-US'] && (settings.course === 'all' || row['Stage'] === settings.course))
                .forEach(row => {
                    const englishWord = row['en-US'], pos = row['POS'] || '';
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.innerHTML = `<span class="pos-tag">${pos}</span><span class="word-txt">...</span>`;
                    container.appendChild(chip);

                    getTranslatedWord(englishWord, pos, settings.lang).then(data => {
                        chip.querySelector('.word-txt').textContent = data.text;
                        chip.onclick = () => {
                            document.getElementById('wordDisplay').textContent = data.text;
                            currentTargetReading = data.reading;
                            fetchIPA(data.text, data.reading);
                        };
                    });
                });
        }

        async function fetchIPA(word, reading) {
            const settings = getGlobalSettings();
            if (!settings.key) return;
            const el = document.getElementById('ipaDisplay');
            el.textContent = "ğŸ” æŸ¥è©¢ä¸­...";

            const prompt = `Provide IPA for "${word}" in ${settings.lang} based on reading "${reading}". Output JSON: {"ipa": "/.../"}`;
            try {
                const resp = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${settings.key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [{ role: "user", content: prompt }],
                        response_format: { type: "json_object" }
                    })
                });
                const d = await resp.json();
                el.textContent = JSON.parse(d.choices[0].message.content).ipa;
            } catch (e) { el.textContent = "N/A"; }
        }

        // --- éŒ„éŸ³èˆ‡å›æ’­ ---
        document.getElementById('recordBtn').onclick = () => (recorder && recorder.recording) ? stopRec() : startRec();

        function startRec() {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gumStream = stream;
                recorder = new Recorder(audioContext.createMediaStreamSource(stream), { numChannels: 1 });
                recorder.record();
                document.getElementById('recordBtn').classList.add('active');
                document.getElementById('recordStatus').textContent = "æ­£åœ¨æ”¶éŸ³...";
                seconds = 0;
                timerInterval = setInterval(() => {
                    seconds++;
                    document.getElementById('timer').textContent = `00:0${seconds} / 00:05`;
                    if (seconds >= 5) stopRec();
                }, 1000);
            });
        }

        function stopRec() {
            if (!recorder) return;
            recorder.stop();
            gumStream.getAudioTracks()[0].stop();
            clearInterval(timerInterval);
            document.getElementById('recordBtn').classList.remove('active');
            document.getElementById('recordStatus').textContent = "åˆ†æè¨ºæ–·ä¸­...";
            recorder.exportWAV(blob => {
                if (lastRecordingUrl) URL.revokeObjectURL(lastRecordingUrl);
                lastRecordingUrl = URL.createObjectURL(blob);
                document.getElementById('replayBtn').disabled = false;
                processAudio(blob);
            });
        }

        function playLastRecording() {
            if (lastRecordingUrl) new Audio(lastRecordingUrl).play();
        }

        async function processAudio(blob) {
            const formData = new FormData();
            formData.append("file", blob, "rec.wav");
            try {
                const resp = await fetch(ALLOSAURUS_API, { method: "POST", body: formData });
                const data = await resp.json();
                getDiagnosis(data.ipa);
            } catch (e) { document.getElementById('recordStatus').textContent = "è¾¨è­˜å¤±æ•—"; }
        }

        // --- è¨ºæ–·é‚è¼¯ï¼šå°‡å°éŒ¯åˆ¤å®šæ¬Šæ”¶å›å‰ç«¯ ---
        async function getDiagnosis(userIpa) {
            const key = getGlobalSettings().key;
            const target = document.getElementById('ipaDisplay').textContent;

            const prompt = `ä½ ç¾åœ¨æ˜¯ç²¾ç¢ºçš„èªéŸ³å°é½Šå°ˆå®¶ã€‚æ¨™æº–éŸ³æ¨™ "${target}"ï¼Œå¯¦éš›è¾¨è­˜ "${userIpa}"ã€‚
            ä»»å‹™ï¼šå°‡å…©è€…ä¸€å°ä¸€å°é½Šã€‚ç¦æ­¢åœ¨è¼¸å‡ºåŠ å…¥é»è™Ÿ(.)æˆ–ç©ºæ ¼ã€‚æ¼è®€è«‹ç•™ç©ºã€‚æä¾›ç¹é«”ä¸­æ–‡å»ºè­°ã€‚
            JSON æ ¼å¼: {"comparison": [{"char": "æ¨™æº–ç¬¦è™Ÿ", "actual": "å¯¦éš›ç¬¦è™Ÿ"}], "phonemes": [{"s": "å­—å…ƒ", "guide": "è‚Œè‚‰èª¿æ•´å»ºè­°", "pos": "ç™¼éŸ³ä½ç½®"}]}`;

            try {
                const resp = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [{ role: "user", content: prompt }],
                        response_format: { type: "json_object" }
                    })
                });
                const d = await resp.json();
                const res = JSON.parse(d.choices[0].message.content);
                renderComparison(res.comparison);
                renderPhonemes(res.phonemes);
                document.getElementById('recordStatus').textContent = "âœ… åˆ†æå®Œæˆï¼Œå¯é»æ“ŠéŸ³ç´ æˆ–å›æ’­éŒ„éŸ³";
            } catch (e) { document.getElementById('recordStatus').textContent = "âŒ è¨ºæ–·å¤±æ•—"; }
        }

        // --- æ ¸å¿ƒç¡¬æ€§æ¯”å°æ¸²æŸ“ï¼šåªè¦ç¬¦è™Ÿé•·å¾—ä¸€æ¨£ï¼Œå°±æ˜¯ç¶ è‰² ---
        function renderComparison(list) {
            const wrap = document.getElementById('ipa-result');
            wrap.innerHTML = "";
            list.forEach(item => {
                const span = document.createElement('span');

                // æ¸…æ´—ç¬¦è™Ÿï¼šå‰”é™¤é»è™Ÿã€ç©ºæ ¼ï¼Œçµ±ä¸€ç·¨ç¢¼
                const expected = (item.char || "").replace(/[.\s]/g, '').normalize('NFC');
                const actual = (item.actual || "").replace(/[.\s]/g, '').normalize('NFC');

                span.textContent = item.char;

                // ç¡¬æ ¸æ¯”å°é‚è¼¯
                const isMatch = (expected !== "" && expected === actual);

                if (isMatch) {
                    span.className = "char-correct";
                } else {
                    span.className = "char-wrong";
                    span.title = actual === "" ? "æ¼è®€" : `è¾¨è­˜ç‚º: ${actual}`;
                }
                wrap.appendChild(span);
            });
        }

        function renderPhonemes(phs) {
            const wrap = document.getElementById('phoneme-wrap');
            wrap.innerHTML = "";
            phs.forEach(p => {
                const d = document.createElement('div');
                d.className = 'ph-block';
                d.textContent = p.s;
                d.onclick = () => {
                    document.getElementById('diag-box').style.display = 'block';
                    document.getElementById('diag-content').innerHTML = `<b>ç™¼éŸ³ä½ç½®ï¼š</b>${p.pos}<br><b>å»ºè­°ï¼š</b>${p.guide}`;
                };
                wrap.appendChild(d);
            });
        }

        function speakCurrentWord() {
            const u = new SpeechSynthesisUtterance(currentTargetReading || document.getElementById('wordDisplay').textContent);
            u.lang = getGlobalSettings().lang;
            speechSynthesis.speak(u);
        }
    </script>
</body>

</html>