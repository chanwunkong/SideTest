<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Ë™ûÂ°äÊµÅÂãïÂ†¥ v2.3 - ÊñáÂ≠óËº∏ÂÖ•Áâà</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            --overheat: #f43f5e;
            --warm: #fbbf24;
            --cold: #94a3b8;
            --pos-noun: #3b82f6;
            --pos-verb: #22c55e;
            --pos-adj: #f59e0b;
            --pos-other: #94a3b8;
        }

        #initOverlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .init-card {
            width: 100%;
            max-width: 400px;
            background: var(--card);
            padding: 30px;
            border-radius: 24px;
            border: 1px solid #334155;
            text-align: center;
        }

        .init-card input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            background: #0f172a;
            border: 1px solid #334155;
            color: white;
            border-radius: 8px;
        }

        .hud-header {
            background: #0f172a;
            padding: 20px;
            border-bottom: 2px solid #334155;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .asset-rack {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .word-asset {
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid var(--cold);
            font-size: 13px;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .word-asset.warm {
            border-color: var(--warm);
            color: var(--warm);
        }

        .word-asset.overheat {
            border-color: var(--overheat);
            color: var(--overheat);
            font-weight: bold;
            box-shadow: 0 0 10px rgba(244, 63, 94, 0.3);
        }

        #chatBox {
            height: 40vh;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            position: relative;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .ai-msg {
            background: #1e293b;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .user-msg {
            background: #334155;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .replay-hint {
            font-size: 10px;
            color: var(--accent);
            display: block;
            margin-top: 5px;
            opacity: 0.6;
        }

        .chunk {
            display: inline-block;
            margin: 2px;
            padding: 2px 4px;
            border-radius: 4px;
            border-bottom: 2px solid transparent;
        }

        .chunk.noun {
            color: var(--pos-noun);
            border-bottom-color: var(--pos-noun);
        }

        .chunk.verb {
            color: var(--pos-verb);
            border-bottom-color: var(--pos-verb);
        }

        .chunk.adj {
            color: var(--pos-adj);
            border-bottom-color: var(--pos-adj);
        }

        .chunk.other {
            color: var(--pos-other);
        }

        .dealer-tray {
            padding: 15px;
            background: #020617;
            border-top: 1px solid #1e293b;
        }

        .signal-option {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            text-align: left;
            background: #1e293b;
            border: 1px solid #334155;
            color: #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        /* Â∫ïÈÉ®Ëº∏ÂÖ•Ê°ÜÂçÄÂüü */
        .input-area {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: #0f172a;
            border-top: 1px solid #1e293b;
        }

        #userInput {
            flex: 1;
            background: #1e293b;
            border: 1px solid #334155;
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
        }

        #sendBtn {
            width: 80px;
            background: var(--btn);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div id="initOverlay">
        <div class="init-card">
            <h2>Ë™ûÂ°äÂçîË≠∞ÂïüÂãï</h2>
            <input type="text" id="sceneInput" placeholder="Ëº∏ÂÖ•Â†¥ÊôØÔºàÂ¶ÇÔºöÈù¢Ë©¶Ôºâ">
            <button onclick="startProtocol(document.getElementById('sceneInput').value)"
                style="width: 100%;">ÈñãÂßãÁ∑¥Áøí</button>
            <button onclick="startProtocol(null)"
                style="width: 100%; background: #1e293b; margin-top: 10px;">Èö®Ê©üÂ†¥ÊôØ</button>
        </div>
    </div>

    <div class="hud-header">
        <div id="assetRack" class="asset-rack"></div>
    </div>

    <div id="chatBox"></div>

    <div class="dealer-tray">
        <div id="optionsContainer"></div>
    </div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="Ëº∏ÂÖ•ÊñáÂ≠óÊàñ‰ΩøÁî®Ëº∏ÂÖ•Ê≥ïË™ûÈü≥..." autocomplete="off">
        <button id="sendBtn">ÂÇ≥ÈÄÅ</button>
    </div>

    <script>
        let currentUserId = null;
        let wordAssets = {};
        let currentScene = "";

        function getActiveSettings() {
            return {
                key: localStorage.getItem('gptApiKey'),
                lang: localStorage.getItem('userLang') || 'en-US',
                course: localStorage.getItem('userCourse') || 'all' // Êñ∞Â¢ûË™≤Á®ãÈÄ≤Â∫¶
            };
        }
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                loadAssets();
            } else {
                loadDefaultAssets();
            }
        });

        async function loadAssets() {
            const settings = getActiveSettings();
            try {
                const snapshot = await db.collection('users').doc(currentUserId)
                    .collection('mastery').where('lang', '==', settings.lang).limit(5).get();
                if (snapshot.empty) return loadDefaultAssets();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    wordAssets[data.word] = { level: data.count || 0, heat: 'Cold' };
                    renderWord(data.word);
                });
            } catch (e) { loadDefaultAssets(); }
        }

        function loadDefaultAssets() {
            ["book", "need", "time"].forEach(w => {
                wordAssets[w] = { level: 0, heat: 'Cold' };
                renderWord(w);
            });
        }

        function renderWord(word) {
            const rack = document.getElementById('assetRack');
            let el = document.getElementById(`asset-${word}`);
            if (!el) {
                el = document.createElement('div');
                el.id = `asset-${word}`; el.className = 'word-asset';
                rack.appendChild(el);
            }
            const data = wordAssets[word];
            el.className = `word-asset ${data.heat.toLowerCase()}`;
            el.innerHTML = `${word.toUpperCase()} <small>Lv.${Math.floor(data.level / 3)}</small>`;
        }

        async function startProtocol(customScene) {
            document.getElementById('initOverlay').style.display = 'none';
            currentScene = customScene || "Daily Chat";
            await nextTurn("Protocol engaged. You can type or use system voice input.");
        }

        async function nextTurn(aiSpeech) {
            appendMessage("AI", aiSpeech);
            const settings = getActiveSettings();
            const words = Object.keys(wordAssets).join(", ");

            // Ê†πÊìö course Ë®≠ÂÆöÂÆöÁæ©Èõ£Â∫¶Êåá‰ª§
            let levelConstraint = "";
            if (settings.course === "Stage 1") levelConstraint = "Use ONLY extremely basic vocabulary (Core 40 level).";
            else if (settings.course === "Stage 2") levelConstraint = "Use simple daily vocabulary (Swadesh list level).";
            else if (settings.course === "Stage 3") levelConstraint = "Use intermediate vocabulary suitable for CEFR learners.";

            const prompt = `
            Role: Smart Dealer. 
            Language: ${settings.lang}. 
            Target Level: ${settings.course}. ${levelConstraint}
            Current Scene: ${currentScene}. 
            User Mastery Words: [${words}].
            
            Task: Generate 3 signaling options for the user. 
            Constraint: The options MUST align with the ${settings.course} proficiency level.
            
            Return JSON Format:
            {
                "heavy": [{"t": "advanced chunk", "p": "pos"}],
                "light": [{"t": "basic chunk", "p": "pos"}],
                "distractor": [{"t": "filler chunk", "p": "pos"}]
            }`;

            const response = await fetchGPT(prompt);
            renderOptions(JSON.parse(response));
        }

        function renderOptions(options) {
            const container = document.getElementById('optionsContainer');
            container.innerHTML = "";
            for (let type in options) {
                const btn = document.createElement('button');
                btn.className = 'signal-option';
                options[type].forEach(chunk => {
                    const span = document.createElement('span');
                    span.className = `chunk ${chunk.p}`;
                    span.innerText = chunk.t;
                    btn.appendChild(span);
                });
                btn.onclick = () => {
                    const fullText = options[type].map(c => c.t).join(" ");
                    handleInput(fullText, type.toUpperCase());
                };
                container.appendChild(btn);
            }
        }

        async function handleInput(text, signalType) {
            if (!text.trim()) return;
            appendMessage("User", text);
            updateAssets(text, signalType);

            const settings = getActiveSettings();
            const prompt = `
            Scene: ${currentScene}. 
            User Level: ${settings.course}.
            User Input: "${text}".
            
            Response Guidance:
            - Respond as an AI interlocutor.
            - Keep your response's complexity at the ${settings.course} level.
            - If the user input was 'HEAVY', move the conversation forward significantly.
            
            Return JSON: {"s": "Your simple and clear response"}
            `;

            const res = await fetchGPT(prompt);
            const data = JSON.parse(res);
            nextTurn(data.s);
            document.getElementById('userInput').value = "";
        }

        function updateAssets(text, type) {
            for (let word in wordAssets) {
                if (text.toLowerCase().includes(word.toLowerCase())) {
                    wordAssets[word].heat = (type === 'HEAVY') ? 'Overheat' : 'Warm';
                    wordAssets[word].level += (type === 'HEAVY') ? 2 : 1;
                    renderWord(word);
                    if (currentUserId) saveToFirebase(word, wordAssets[word].level);
                }
            }
        }

        async function fetchGPT(prompt) {
            const settings = getActiveSettings();
            if (!settings.key) return JSON.stringify({ heavy: [], light: [], distractor: [] });
            const res = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${settings.key}` },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: [{ role: "user", content: prompt }],
                    response_format: { type: "json_object" }
                })
            });
            const data = await res.json();
            return data.choices[0].message.content;
        }

        function appendMessage(role, text) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `message ${role === 'AI' ? 'ai-msg' : 'user-msg'}`;
            div.innerHTML = `<span>${text}</span><small class="replay-hint">üîä Click to replay</small>`;
            div.onclick = () => speak(text);
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            speak(text);
        }

        function speak(txt) {
            speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = getActiveSettings().lang;
            speechSynthesis.speak(u);
        }

        async function saveToFirebase(word, count) {
            const settings = getActiveSettings();
            const masteryId = `${settings.lang}_${word}`.replace(/[\/\.#$\[\]\s]/g, '_');
            await db.collection('users').doc(currentUserId).collection('mastery').doc(masteryId).set({
                count: count, lastStudied: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }

        // ÈÄÅÂá∫ÊåâÈàïËàá Enter ÈçµÂÅµËÅΩ
        document.getElementById('sendBtn').onclick = () => {
            const val = document.getElementById('userInput').value;
            handleInput(val, 'USER_TYPING');
        };
        document.getElementById('userInput').onkeypress = (e) => {
            if (e.key === 'Enter') {
                handleInput(e.target.value, 'USER_TYPING');
            }
        };
    </script>
</body>

</html>