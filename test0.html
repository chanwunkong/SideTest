<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>éŸ³ä½è¨ºæ–· - èªéŸ³æ•™ç·´å®Œæ•´ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script>
    <style>
        :root {
            --bg: #0b1220;
            --card: #111827;
            --text: #e5e7eb;
            --accent: #22d3ee;
            --btn: #0ea5e9;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, sans-serif;
            padding: 20px;
            line-height: 1.5;
        }

        .wrap {
            max-width: 680px;
            margin: 0 auto;
        }

        .app {
            background: var(--card);
            border: 1px solid #1f2937;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }

        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 13px;
            color: #64748b;
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            max-height: 120px;
            overflow-y: auto;
        }

        .chip {
            padding: 8px 12px;
            border-radius: 12px;
            background: #1f2937;
            cursor: pointer;
            border: 1px solid transparent;
            text-align: center;
            min-width: 60px;
        }

        .chip:hover {
            border-color: var(--accent);
        }

        .pos-tag {
            font-size: 9px;
            color: var(--accent);
            display: block;
            text-transform: uppercase;
        }

        #wordDisplay {
            font-size: 48px;
            font-weight: bold;
            color: var(--accent);
            text-align: center;
            margin: 10px 0;
        }

        .layer {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.02);
            text-align: center;
        }

        .layer-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            display: block;
        }

        #ipaDisplay {
            font-size: 24px;
            font-family: monospace;
        }

        #raw-ipa-result {
            font-size: 32px;
            font-weight: bold;
            color: var(--warning);
            font-family: 'Charis SIL', monospace;
        }

        #ipa-result {
            font-size: 36px;
            font-family: 'Charis SIL', monospace;
            letter-spacing: 4px;
        }

        .char-correct {
            color: var(--success);
        }

        .char-wrong {
            color: var(--danger);
            text-decoration: underline wavy;
        }

        .ph-block {
            display: inline-block;
            padding: 12px 18px;
            background: #1f2937;
            border-radius: 12px;
            cursor: pointer;
            margin: 6px;
            border: 2px solid #334155;
            font-size: 20px;
            transition: 0.2s;
        }

        .ph-block:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        #diag-box {
            background: #0f172a;
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--accent);
            display: none;
            text-align: left;
        }

        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--danger);
            border: none;
            cursor: pointer;
            font-size: 32px;
            margin: 20px auto;
            display: block;
        }

        .record-btn.active {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .action-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            flex: 1;
            padding: 16px;
            border-radius: 14px;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }

        .primary {
            background: var(--btn);
            color: #000;
        }

        .secondary {
            background: #374151;
            color: #fff;
        }

        .back-link {
            color: var(--accent);
            text-decoration: none;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="app">
            <div class="header">
                <a href="index.html" class="back-link">â† è¿”å›æ§åˆ¶ä¸­å¿ƒ</a>
                <span id="langDisplay" style="font-size: 12px; color: #94a3b8;">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="chips" id="samples"></div>
            <h1 id="wordDisplay">é¸æ“‡å–®å­—</h1>

            <div class="layer" onclick="speakIPA()" style="cursor: pointer;">
                <span class="layer-label">Step 1: æ¨™æº–ç™¼éŸ³</span>
                <div id="ipaDisplay" style="color: var(--accent); text-decoration: underline dotted;">[ -- ]</div>
            </div>

            <div class="layer" style="border: 1px dashed var(--warning);">
                <span class="layer-label">Step 2: éŒ„éŸ³è¾¨è­˜ (API)</span>
                <div id="raw-ipa-result">--</div>
            </div>

            <div class="layer">
                <span class="layer-label">Step 3: çŸ¯æ­£æ•™å­¸ </span>
                <div id="ipa-result"></div>
                <div id="phoneme-wrap"></div>
                <div id="diag-box">
                    <div id="diag-content"></div>
                </div>
            </div>

            <div class="record-container">
                <div id="timer" style="text-align:center; color:#6b7280; font-size:14px; margin-bottom:5px;">00:00 /
                    00:05</div>
                <button class="record-btn" id="recordBtn">ğŸ¤</button>
                <div id="recordStatus" style="text-align:center; color:var(--accent);">é»æ“ŠéŒ„éŸ³</div>
            </div>

            <div class="action-group">
                <button onclick="speakCurrentWord()" class="action-btn primary">â–¶ æ’­æ”¾å–®å­—æ¨™æº–éŸ³</button>
                <button id="replayBtn" onclick="playLastRecording()" class="action-btn secondary" disabled>ğŸ‘‚
                    å›æ’­æˆ‘çš„éŒ„éŸ³</button>
            </div>
        </div>
    </div>

    <script>
        const ALLOSAURUS_API = "https://allosaurus-api-878665537417.asia-east1.run.app/recognize";

        // --- æ ¸å¿ƒä¿®å¾©ï¼šå¾æœ¬åœ°å¿«å–è®€å– index.html æ´¾ç™¼çš„é…ç½® ---
        const savedConfig = localStorage.getItem('firebaseConfig');
        if (savedConfig) {
            // å‹•æ…‹åˆå§‹åŒ– Firebase æ‰€æœ‰çš„åŠŸèƒ½ (å« Storage, Firestore, Auth)
            firebase.initializeApp(JSON.parse(savedConfig));
        } else {
            // å®‰å…¨æª¢æŸ¥ï¼šè‹¥æœªå¾é¦–é åˆå§‹åŒ–ï¼Œå¼·åˆ¶å°å›
            alert("æœªåµæ¸¬åˆ°æˆæ¬Šé…ç½®ï¼Œè«‹å¾æ§åˆ¶ä¸­å¿ƒç™»å…¥");
            window.location.href = "index.html";
        }

        const db = firebase.firestore();
        const auth = firebase.auth();

        // ... åŸæœ‰çš„è®Šæ•¸èˆ‡é‚è¼¯ ...
        const getGlobalSettings = () => ({
            lang: localStorage.getItem('userLang') || 'it-IT',
            // é€™è£¡åŒæ¨£æ”¹å¾å¿«å–æ‹¿å–æ‚¨å­˜åœ¨ Firestore çš„å€‹äºº GPT Key
            key: localStorage.getItem('gptApiKey') || '',
            course: localStorage.getItem('userCourse') || 'all'
        });

        auth.onAuthStateChanged(user => {
            userId = user ? user.uid : null;
            document.getElementById('langDisplay').textContent = `ç›®æ¨™èªè¨€ï¼š${getGlobalSettings().lang}`;
            loadSwadeshCSV();
        });

        async function loadSwadeshCSV() {
            try {
                const resp = await fetch('swadesh.csv');
                window.allWordData = Papa.parse(await resp.text(), { header: true, skipEmptyLines: true }).data;
                renderChips();
            } catch (e) { console.error(e); }
        }

        async function getTranslatedWord(englishWord, pos, targetLang) {
            const cacheId = `trans_${targetLang}_${englishWord}_${pos}`.replace(/[\/\.#$\[\]\s]/g, '_');
            const cacheDoc = await db.collection('translation_cache').doc(cacheId).get();
            if (cacheDoc.exists) return cacheDoc.data();

            const prompt = `Translate "${englishWord}" (${pos}) into ${targetLang}. JSON: {"text": "word", "reading": "phonetic"}`;
            const resp = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST", headers: { "Authorization": `Bearer ${getGlobalSettings().key}`, "Content-Type": "application/json" },
                body: JSON.stringify({ model: "gpt-4o-mini", messages: [{ role: "user", content: prompt }], response_format: { type: "json_object" } })
            });
            const res = JSON.parse((await resp.json()).choices[0].message.content);
            await db.collection('translation_cache').doc(cacheId).set(res);
            return res;
        }

        function renderChips() {
            const container = document.getElementById('samples');
            container.innerHTML = '';
            window.allWordData.filter(row => row['en-US']).forEach(row => {
                const chip = document.createElement('div');
                chip.className = 'chip'; chip.innerHTML = `<span class="pos-tag">${row['POS']}</span>...`;
                container.appendChild(chip);
                getTranslatedWord(row['en-US'], row['POS'], getGlobalSettings().lang).then(data => {
                    chip.innerHTML = `<span class="pos-tag">${row['POS']}</span>${data.text}`;
                    chip.onclick = () => {
                        document.getElementById('wordDisplay').textContent = data.text;
                        currentTargetReading = data.reading;
                        fetchIPA(data.text, data.reading);
                    };
                });
            });
        }

        async function fetchIPA(word, reading) {
            const el = document.getElementById('ipaDisplay');
            el.textContent = "ğŸ” æŸ¥è©¢ä¸­...";
            // ä¿®æ”¹ Prompt è¦æ±‚å›å‚³éŸ³æª”åç¨±
            const prompt = `Provide IPA for "${word}" in ${getGlobalSettings().lang}. 
    JSON: {"ipa": "/.../", "mainAudio": "Alveolar tap.ogg"}`;

            const resp = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${getGlobalSettings().key}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [{ role: "user", content: prompt }],
                    response_format: { type: "json_object" }
                })
            });

            const res = JSON.parse((await resp.json()).choices[0].message.content);
            el.textContent = res.ipa;
            // å°‡éŸ³æª”åç¨±å­˜åœ¨ element çš„ dataset ä¸­ï¼Œé»æ“Šæ™‚èª¿ç”¨
            el.dataset.audio = res.mainAudio;
        }

        // æ”¾åœ¨ script æ¨™ç±¤å…§çš„ä»»æ„ä½ç½®
        function speakIPA() {
            const ipaText = document.getElementById('ipaDisplay').textContent;
            if (ipaText === "[ -- ]" || ipaText === "ğŸ” æŸ¥è©¢ä¸­...") return;

            // æ¸…é™¤ IPA å¸¸è¦‹çš„æ–œæ§“æˆ–æ‹¬è™Ÿä»¥ä¾¿åˆæˆå™¨è®€å–
            const cleanIpa = ipaText.replace(/[\/\(\)\[\]]/g, '');
            const u = new SpeechSynthesisUtterance(cleanIpa);

            // è¨­å®šç‚ºç›®æ¨™èªè¨€
            u.lang = getGlobalSettings().lang;
            speechSynthesis.speak(u);
        }

        document.getElementById('recordBtn').onclick = () => (recorder && recorder.recording) ? stopRec() : startRec();

        function startRec() {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                audioContext = new AudioContext(); gumStream = stream;
                recorder = new Recorder(audioContext.createMediaStreamSource(stream), { numChannels: 1 });
                recorder.record(); document.getElementById('recordBtn').classList.add('active');
                seconds = 0;
                timerInterval = setInterval(() => {
                    seconds++;
                    document.getElementById('timer').textContent = `00:0${seconds} / 00:05`;
                    if (seconds >= 5) stopRec();
                }, 1000);
            });
        }

        function stopRec() {
            recorder.stop(); gumStream.getAudioTracks()[0].stop();
            clearInterval(timerInterval);
            document.getElementById('recordBtn').classList.remove('active');
            recorder.exportWAV(blob => {
                lastRecordingUrl = URL.createObjectURL(blob);
                document.getElementById('replayBtn').disabled = false;
                processAudio(blob);
            });
        }

        async function processAudio(blob) {
            const formData = new FormData(); formData.append("file", blob, "rec.wav");
            const resp = await fetch(ALLOSAURUS_API, { method: "POST", body: formData });
            const data = await resp.json();
            document.getElementById('raw-ipa-result').textContent = data.ipa || "(ç„¡åµæ¸¬)";
            getDiagnosis(data.ipa);
        }

        async function getDiagnosis(userIpa) {
            const target = document.getElementById('ipaDisplay').textContent;
            const prompt = `ä½ ç¾åœ¨æ˜¯èªéŸ³å­¸æ•™ç·´ã€‚é‡å° "${userIpa}"ï¼š
            1. å°é½Šåˆ° comparisonã€‚
            2. é‡å°ç¬¦è™Ÿæä¾›ç”Ÿç†å·®ç•°(diff)èˆ‡ä¿®æ­£å‹•ä½œ(guide)ã€‚
            3. æ‰¾å‡ºå°æ‡‰ Wikipedia çš„æ¨™æº–éŸ³æª”æª”å (audioName)ï¼ˆå¦‚ "Alveolar tap.ogg"ï¼‰ã€‚
            JSON: {"comparison": [{"char": "æ¨™", "actual": "è¾¨"}], "phonemes": [{"s": "ç¬¦è™Ÿ", "diff": "ç”Ÿç†åŸå› ", "guide": "ä¿®æ­£", "audioName": "æª”å.ogg"}]}`;

            const resp = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST", headers: { "Authorization": `Bearer ${getGlobalSettings().key}`, "Content-Type": "application/json" },
                body: JSON.stringify({ model: "gpt-4o-mini", messages: [{ role: "user", content: prompt }], response_format: { type: "json_object" } })
            });
            const res = JSON.parse((await resp.json()).choices[0].message.content);
            renderComparison(res.comparison);
            renderPhonemes(res.phonemes);
        }

        function renderComparison(list) {
            const wrap = document.getElementById('ipa-result'); wrap.innerHTML = "";
            list.forEach(item => {
                const span = document.createElement('span');
                span.textContent = item.actual || item.char;
                span.className = (item.char === item.actual) ? "char-correct" : "char-wrong";
                wrap.appendChild(span);
            });
        }

        function playIpaSound(p) {
            if (p.audioName && p.audioName !== "N/A") {
                new Audio(`https://commons.wikimedia.org/wiki/Special:FilePath/${p.audioName}`).play().catch(() => useFallback(p.s));
            } else { useFallback(p.s); }
        }
        function useFallback(s) {
            const u = new SpeechSynthesisUtterance(s.replace(/[\/\(\)\[\]]/g, ''));
            u.lang = 'it-IT'; speechSynthesis.speak(u);
        }

        function renderPhonemes(phs) {
            const wrap = document.getElementById('phoneme-wrap'); wrap.innerHTML = "";
            phs.forEach(p => {
                const d = document.createElement('div'); d.className = 'ph-block'; d.textContent = p.s;
                d.onclick = () => {
                    playIpaSound(p);
                    document.getElementById('diag-box').style.display = 'block';
                    document.getElementById('diag-content').innerHTML = `<h3>[${p.s}] èª¿æ•´å»ºè­°</h3><p><b>ğŸ” åŸå› ï¼š</b>${p.diff}</p><p><b>ğŸ’¡ ä¿®æ­£ï¼š</b>${p.guide}</p>`;
                };
                wrap.appendChild(d);
            });
        }

        function playLastRecording() { if (lastRecordingUrl) new Audio(lastRecordingUrl).play(); }
        function speakCurrentWord() {
            const u = new SpeechSynthesisUtterance(currentTargetReading || document.getElementById('wordDisplay').textContent);
            u.lang = getGlobalSettings().lang; speechSynthesis.speak(u);
        }
    </script>
</body>

</html>